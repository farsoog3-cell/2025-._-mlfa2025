<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>باترون تطريز احترافي</title>
<style>
body { font-family: Arial; text-align:center; background:#111; color:#fff; }
canvas { border:1px solid #000; margin-top:20px; max-width:100%; }
button,input,select { padding:10px; margin:5px; border-radius:5px; }
</style>
</head>
<body>

<h1>باترون تطريز احترافي مع Satin وEdge</h1>

<input type="file" id="imageInput" accept="image/*"><br>
<button id="bwBtn">تحويل إلى أبيض وأسود</button>
<button id="analyzeBtn">استخراج الغرز والمسارات</button><br>
<canvas id="canvas"></canvas><br>
<input type="text" id="fileName" value="stitch_pattern" placeholder="اسم الملف">
<button id="downloadBtn">تنزيل ملف PES</button>
<div id="info"></div>

<script>
const SERVER_URL = "https://2025mlfa-2-7e2x.onrender.com/generate_pes";
const imageInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const bwBtn = document.getElementById('bwBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const fileNameInput = document.getElementById('fileName');
const info = document.getElementById('info');

let img = new Image();
let stitchPoints = [];

// رفع الصورة
imageInput.addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img,0,0);
    };
    img.src = URL.createObjectURL(file);
});

// تحويل الصورة إلى أبيض وأسود
bwBtn.addEventListener('click', () => {
    ctx.drawImage(img,0,0);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;
    for(let i=0;i<data.length;i+=4){
        const gray = 0.3*data[i]+0.59*data[i+1]+0.11*data[i+2];
        const bw = gray > 128 ? 255 : 0;
        data[i]=data[i+1]=data[i+2]=bw;
    }
    ctx.putImageData(imageData,0,0);
});

// استخراج الغرز مع تحديد نوع الغرز وزاوية Satin
analyzeBtn.addEventListener('click', () => {
    ctx.drawImage(img,0,0);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;
    stitchPoints = [];
    const threshold = 128;
    const step = 4;
    const satin_angle = Math.PI/4; // زاوية الغرز الطويلة

    for(let y=0;y<canvas.height;y+=step){
        const rowPoints = [];
        for(let x=0;x<canvas.width;x+=step){
            const i = (y*canvas.width+x)*4;
            const gray = 0.3*data[i]+0.59*data[i+1]+0.11*data[i+2];
            if(gray<threshold){
                let type='fill';
                // الحواف الخارجية أو خطوط Satin
                if(x<step || x>canvas.width-step || y<step || y>canvas.height-step) type='edge';
                if((x+y)%20===0) type='satin'; // مثال لتوليد Satin
                rowPoints.push({x:x,y:y,type:type,angle:satin_angle});
                // رسم معاينة
                if(type==='edge') ctx.fillStyle="#f00";
                else if(type==='fill') ctx.fillStyle="#0f0";
                else ctx.fillStyle="#00f";
                ctx.fillRect(x,y,1,1);
            }
        }
        if((y/step)%2===1) rowPoints.reverse();
        stitchPoints.push(...rowPoints);
    }

    info.textContent=`عدد الغرز: ${stitchPoints.length} - معاينة المسارات جاهزة`;
});

// تنزيل ملف PES
downloadBtn.addEventListener('click', () => {
    if(stitchPoints.length===0){ alert("تحليل الصورة أولاً"); return; }
    const fileName = fileNameInput.value || 'stitch_pattern';

    fetch(SERVER_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({points:stitchPoints})
    })
    .then(res=>res.blob())
    .then(blob=>{
        const link=document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${fileName}.pes`;
        link.click();
        info.textContent="تم إنشاء ملف PES احترافي مع Satin وEdge بنجاح!";
    })
    .catch(err=>{
        console.error(err);
        info.textContent="خطأ أثناء إنشاء الملف";
    });
});
</script>

</body>
</html>
