<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>باترون تطريز متقدم</title>
<style>
body { font-family: Arial; text-align:center; background:#111; color:#fff; }
canvas { border:1px solid #000; margin-top:10px; max-width:100%; }
button,input { padding:10px; margin:5px; border-radius:5px; }
#images { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
</style>
</head>
<body>

<h1>باترون تطريز متقدم</h1>
<input type="file" id="imageInput" accept="image/*"><br>
<button id="processBtn">رفع ومعالجة الصورة</button><br>

<div id="images">
<canvas id="canvasOriginal"></canvas>
<canvas id="canvasProcessed"></canvas>
</div>

<input type="text" id="fileName" value="stitch_pattern" placeholder="اسم الملف">
<button id="downloadBtn">تنزيل ملف PES</button>
<div id="info"></div>

<script>
const SERVER_URL = "https://2025mlfa-2-7e2x.onrender.com/process_image";

const imageInput = document.getElementById('imageInput');
const processBtn = document.getElementById('processBtn');
const downloadBtn = document.getElementById('downloadBtn');
const fileNameInput = document.getElementById('fileName');
const info = document.getElementById('info');

const canvasOriginal = document.getElementById('canvasOriginal');
const ctxOriginal = canvasOriginal.getContext('2d');

const canvasProcessed = document.getElementById('canvasProcessed');
const ctxProcessed = canvasProcessed.getContext('2d');

let stitchPoints = [];
let pesBlob = null;

// رفع ومعالجة الصورة على السيرفر
processBtn.addEventListener('click', () => {
    const file = imageInput.files[0];
    if(!file){ alert("اختر صورة أولاً"); return; }

    const formData = new FormData();
    formData.append('image', file);

    info.textContent = "جاري معالجة الصورة...";
    fetch(SERVER_URL, { method:'POST', body:formData })
    .then(res=>res.json())
    .then(data=>{
        // عرض الصور
        const original = new Image();
        original.onload = ()=>{ 
            canvasOriginal.width = original.width;
            canvasOriginal.height = original.height;
            ctxOriginal.drawImage(original,0,0);
        };
        original.src = data.original;

        const processed = new Image();
        processed.onload = ()=>{
            canvasProcessed.width = processed.width;
            canvasProcessed.height = processed.height;
            ctxProcessed.drawImage(processed,0,0);
        };
        processed.src = data.processed;

        // حفظ نقاط الغرز
        stitchPoints = data.stitchPoints;
        // حفظ ملف PES كبوب
        fetch(data.pes).then(r=>r.blob()).then(b=>{ pesBlob=b; });

        info.textContent = `تمت المعالجة. عدد الغرز: ${stitchPoints.length}`;
    })
    .catch(err=>{
        console.error(err);
        info.textContent = "حدث خطأ أثناء المعالجة";
    });
});

// تنزيل ملف PES
downloadBtn.addEventListener('click', ()=>{
    if(!pesBlob){ alert("يجب معالجة الصورة أولاً"); return; }
    const link = document.createElement('a');
    link.href = URL.createObjectURL(pesBlob);
    link.download = (fileNameInput.value||'stitch_pattern')+'.pes';
    link.click();
    info.textContent="تم تنزيل ملف PES بنجاح";
});
</script>
</body>
</html>
