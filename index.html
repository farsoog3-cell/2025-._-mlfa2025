<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>محول الصور إلى تطريز AI</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<style>
  #preview-container {
    width: 100%;
    height: 400px;
    border: 1px solid #ccc;
    overflow: auto;
    background: #f9f9f9;
    position: relative;
  }
  #preview svg {
    width: 100%;
    height: 100%;
    transform-origin: top left;
  }
</style>
</head>
<body class="bg-gray-100 font-sans">

<div class="min-h-screen flex flex-col items-center justify-center p-4">
  <h1 class="text-4xl font-bold mb-6 text-gray-800">محول الصور إلى تطريز AI متقدم</h1>

  <div class="w-full max-w-lg bg-white shadow-lg rounded-xl p-6 mb-6">
    <input id="fileInput" type="file" accept="image/*" class="block w-full mb-4 p-2 border rounded" />

    <label class="block mb-2 text-gray-700">اختر نوع الملف:</label>
    <select id="fileType" class="w-full mb-4 p-2 border rounded">
      <option value="dst">DST</option>
      <option value="dse">DSE</option>
    </select>

    <button id="uploadBtn" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">رفع وتحويل</button>

    <div id="progress" class="mt-4 hidden w-full bg-gray-200 h-4 rounded">
      <div id="progressBar" class="bg-green-500 h-4 rounded w-0"></div>
    </div>
  </div>

  <div class="w-full max-w-lg bg-white shadow-lg rounded-xl p-6">
    <h2 class="text-2xl font-semibold mb-4 text-gray-700">معاينة المخطط</h2>
    <div id="preview-container">
      <div id="preview" class="w-full h-full flex items-center justify-center">
        <span class="text-gray-400">ستظهر المعاينة هنا بعد التحويل</span>
      </div>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="zoomIn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">تكبير</button>
      <button id="zoomOut" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">تصغير</button>
    </div>

    <a id="downloadLink" href="#" class="hidden mt-4 w-full inline-block text-center bg-green-600 text-white p-3 rounded hover:bg-green-700 transition">تنزيل الملف</a>
  </div>
</div>

<script>
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const fileTypeSelect = document.getElementById('fileType');
const preview = document.getElementById('preview');
const previewContainer = document.getElementById('preview-container');
const downloadLink = document.getElementById('downloadLink');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');

let zoomLevel = 1;

document.getElementById('zoomIn').addEventListener('click', () => {
  zoomLevel *= 1.2;
  preview.style.transform = `scale(${zoomLevel})`;
});

document.getElementById('zoomOut').addEventListener('click', () => {
  zoomLevel /= 1.2;
  preview.style.transform = `scale(${zoomLevel})`;
});

uploadBtn.addEventListener('click', async () => {
  if (!fileInput.files[0]) { alert("يرجى اختيار صورة!"); return; }

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  formData.append('type', fileTypeSelect.value);

  uploadBtn.textContent = "جاري التحويل...";
  uploadBtn.disabled = true;
  progress.classList.remove('hidden');
  progressBar.style.width = "0%";

  try {
    const response = await fetch('https://2025mlfa-1.onrender.com/convert', { method: 'POST', body: formData });
    if (!response.ok) throw new Error("حدث خطأ أثناء التحويل");

    const blob = await response.blob();

    // قراءة الملف كـ text لعرض SVG
    const text = await blob.text();
    preview.innerHTML = text;
    zoomLevel = 1;
    preview.style.transform = `scale(${zoomLevel})`;

    // إنشاء Blob للتنزيل
    const downloadBlob = new Blob([text], { type: "application/octet-stream" });
    const fileUrl = URL.createObjectURL(downloadBlob);
    downloadLink.href = fileUrl;
    downloadLink.download = fileTypeSelect.value === 'dst' ? 'pattern.dst' : 'pattern.dse';
    downloadLink.classList.remove('hidden');

    progressBar.style.width = "100%";

  } catch (err) { alert(err.message); }
  finally {
    uploadBtn.textContent = "رفع وتحويل";
    uploadBtn.disabled = false;
  }
});
</script>
</body>
    </html>
