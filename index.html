<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة رسم DST دقيقة 1:1 حقيقية</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI',sans-serif; display:flex; flex-direction:column; background:#f0f2f5;}
header { background: linear-gradient(90deg,#4b6cb7,#182848); color:#fff; text-align:center; padding:15px 0; font-size:1.4em; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
#main { flex:1 1 auto; display:flex; justify-content:center; align-items:center; padding:20px;}
canvas { display:block; background:#fff; border-radius:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); border:2px solid #ccc;}
#board { width:80vmin; height:80vmin;}
.controls { flex:0 0 auto; padding:10px; background:#fff; display:flex; justify-content:center; align-items:center; border-top:2px solid #ddd; box-shadow:0 -2px 5px rgba(0,0,0,0.05); flex-wrap: wrap;}
button { padding:10px 16px; margin:5px; border-radius:12px; border:none; background:#4b6cb7; color:#fff; font-weight:600; cursor:pointer; transition:0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
button:hover { background:#182848;}
.warn { color:#d00; font-size:0.85em; margin-left:15px;}
</style>
</head>
<body>
<header>لوحة رسم DST دقيقة 1:1 (دوائر حقيقية)</header>
<div id="main"><canvas id="board"></canvas></div>
<div class="controls">
<button id="clear">مسح</button>
<button id="export-dst">تصدير DST</button>
<div class="warn">أي دائرة ترسمها ستظهر بدقة كاملة في الملف.</div>
</div>

<script>
const board = document.getElementById('board');
const ctx = board.getContext('2d');
let strokes=[], current=[], drawing=false;

let BOARD_MM = 200;
let PX_PER_MM = 1;

function resizeCanvas(){
    board.width = board.clientWidth;
    board.height = board.clientHeight;
    PX_PER_MM = board.width / BOARD_MM;
    redraw();
}

window.addEventListener('load', resizeCanvas);
window.addEventListener('resize', resizeCanvas);

function pxToMM(px){ return px / PX_PER_MM; }
function mmToPx(mm){ return mm * PX_PER_MM; }

// رسم الدائرة رياضياً
function generateCirclePoints(cx, cy, r, stepMM=0.05){
    const points=[];
    const circumference = 2*Math.PI*r;
    const steps = Math.ceil(circumference/stepMM);
    for(let i=0;i<steps;i++){
        const angle = (i/steps)*2*Math.PI;
        points.push({x: cx + r*Math.cos(angle), y: cy + r*Math.sin(angle)});
    }
    return points;
}

// إعادة الرسم
function redraw(){
    ctx.clearRect(0,0,board.width,board.height);
    ctx.lineWidth=1.5;
    ctx.strokeStyle='#000';
    ctx.lineJoin='round';
    ctx.lineCap='round';
    for(const s of strokes) drawStroke(s);
    drawStroke(current);
}
function drawStroke(st){ 
    if(!st || st.length<2) return;
    ctx.beginPath();
    ctx.moveTo(st[0].x, st[0].y);
    for(let i=1;i<st.length;i++) ctx.lineTo(st[i].x, st[i].y);
    ctx.stroke();
}

document.getElementById('clear').onclick = ()=>{ strokes=[]; current=[]; redraw(); };

// ===== DST الدقيق =====
function encodeStep(dx, dy, control){
    let b0=0,b1=0,b2=0;
    function applyAxis(v,axis){
        const sign=v<0?-1:1;
        let absv=Math.abs(Math.round(v));
        const W=[81,27,9,3,1];
        for(const w of W){
            if(absv>=w){
                if(axis==='x'){
                    if(w===1)b0|=(sign>0?0x01:0x02);
                    else if(w===9)b0|=(sign>0?0x04:0x08);
                    else if(w===3)b1|=(sign>0?0x01:0x02);
                    else if(w===27)b1|=(sign>0?0x04:0x08);
                    else if(w===81)b2|=(sign>0?0x20:0x40);
                } else{
                    if(w===1)b0|=(sign>0?0x10:0x20);
                    else if(w===9)b0|=(sign>0?0x40:0x80);
                    else if(w===3)b1|=(sign>0?0x10:0x20);
                    else if(w===27)b1|=(sign>0?0x40:0x80);
                    else if(w===81)b2|=(sign>0?0x04:0x08);
                }
                absv-=w;
            }
        }
    }
    applyAxis(dx,'x'); applyAxis(dy,'y');
    if(control===0)b2|=0x03;
    else if(control===1)b2|=0x83;
    else if(control===2)b2|=0x23;
    return [b0&0xFF,b1&0xFF,b2&0xFF];
}

function buildDSTFromPoints(points){
    if(points.length===0) return null;
    let prev = points[0];
    const body=[];
    body.push(...encodeStep(prev.x, prev.y, 1));
    for(let i=1;i<points.length;i++){
        const dx = points[i].x - prev.x;
        const dy = points[i].y - prev.y;
        body.push(...encodeStep(dx, dy, 0));
        prev = points[i];
    }
    body.push(0x00,0x00,0xF3);
    const header = new Uint8Array(512); header.fill(0x20);
    const name='CIRCLE_DST';
    for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
    const buf=new Uint8Array(512+body.length);
    buf.set(header,0); buf.set(new Uint8Array(body),512);
    return buf.buffer;
}

// مثال: توليد دائرة مباشرة
document.getElementById('export-dst').onclick = ()=>{
    const cx = BOARD_MM/2;
    const cy = BOARD_MM/2;
    const r = 50; // دائرة نصف قطر 50 ملم
    const points = generateCirclePoints(cx, cy, r);
    const buf = buildDSTFromPoints(points);
    const blob = new Blob([buf],{type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='circle_true_1to1.dst';
    a.click();
    URL.revokeObjectURL(url);
};
</script>
</body>
</html>
