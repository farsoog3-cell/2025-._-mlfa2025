<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mlfa2025.010</title>
<style>
body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #121212;
    color: #fff;
}
.container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
}
header {
    text-align:center;
    margin-bottom:30px;
}
header h1 {
    font-size:2.5em;
    border-bottom:2px solid #fff;
    padding-bottom:10px;
}
header p {
    font-size:1em;
    color:#aaa;
}
.section {
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
}
canvas {
    border: 1px solid #fff;
    max-width: 100%;
    display: block;
    margin: 10px auto;
    background-color: #000;
}
button, input, select {
    padding: 10px 15px;
    margin: 5px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    background-color: #333;
    color: #fff;
    transition: 0.2s;
}
button:hover, input:hover, select:hover {
    background-color: #555;
}
.options {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
}
#log {
    background-color: #000;
    color: #0f0;
    padding: 15px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #fff;
    font-family: monospace;
}
</style>
</head>
<body>

<div class="container">
<header>
    <h1>mlfa2025.010</h1>
    <p>تطوير: فارس وملهم</p>
</header>

<div class="section">
    <h3>خيارات المعالجة:</h3>
    <div class="options">
        <input type="file" id="imageInput" accept="image/*">
        <select id="downloadFormat">
            <option value="pes">PES</option>
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
        </select>
        <button id="processBtn">ابدأ المعالجة</button>
        <button id="downloadBtn">تنزيل الملف</button>
    </div>
</div>

<div class="section">
    <h3>الصورة الأصلية:</h3>
    <canvas id="canvasOriginal"></canvas>
</div>

<div class="section">
    <h3>الصورة بعد المعالجة:</h3>
    <canvas id="canvasProcessed"></canvas>
</div>

<div class="section">
    <h3>مسارات الغرز:</h3>
    <canvas id="canvasStitch"></canvas>
</div>

<div class="section">
    <h3>سجل العمليات:</h3>
    <div id="log"></div>
</div>
</div>

<script>
const SERVER_URL = "https://2025mlfa-2-7e2x.onrender.com/process_image";

const imageInput = document.getElementById('imageInput');
const processBtn = document.getElementById('processBtn');
const downloadBtn = document.getElementById('downloadBtn');
const downloadFormat = document.getElementById('downloadFormat');

const canvasOriginal = document.getElementById('canvasOriginal');
const ctxOriginal = canvasOriginal.getContext('2d');
const canvasProcessed = document.getElementById('canvasProcessed');
const ctxProcessed = canvasProcessed.getContext('2d');
const canvasStitch = document.getElementById('canvasStitch');
const ctxStitch = canvasStitch.getContext('2d');

const log = document.getElementById('log');

let pesBlob = null;
let uploadedFile = null;

function addLog(msg){
    log.textContent += msg + "\n";
    log.scrollTop = log.scrollHeight;
}

// عرض الصورة الأصلية
imageInput.addEventListener('change', ()=>{
    const file = imageInput.files[0];
    if(!file) return;
    uploadedFile = file;
    const reader = new FileReader();
    reader.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
            canvasOriginal.width = img.width;
            canvasOriginal.height = img.height;
            ctxOriginal.drawImage(img,0,0);
            addLog("تم تحميل الصورة الأصلية: " + file.name);
        }
        img.src = e.target.result;
    }
    reader.readAsDataURL(file);
});

// معالجة الصورة
processBtn.addEventListener('click', ()=>{
    if(!uploadedFile){ alert("اختر صورة أولاً"); return; }
    const formData = new FormData();
    formData.append('image', uploadedFile);
    formData.append('processing', 'full');

    addLog("جارٍ إرسال الصورة للسيرفر...");
    fetch(SERVER_URL,{method:'POST',body:formData})
    .then(res=>res.json())
    .then(data=>{
        if(data.error){
            addLog("حدث خطأ أثناء المعالجة: " + data.error);
            return;
        }
        // عرض الصورة المعالجة
        const imgProcessed = new Image();
        imgProcessed.onload = ()=>{
            canvasProcessed.width = imgProcessed.width;
            canvasProcessed.height = imgProcessed.height;
            ctxProcessed.drawImage(imgProcessed,0,0);
            addLog("تم عرض الصورة بعد المعالجة");
        }
        imgProcessed.src = data.processed;

        // رسم مسارات الغرز
        const points = data.stitchPoints;
        canvasStitch.width = canvasProcessed.width;
        canvasStitch.height = canvasProcessed.height;
        ctxStitch.fillStyle="#000";
        ctxStitch.fillRect(0,0,canvasStitch.width,canvasStitch.height);
        ctxStitch.fillStyle="#0f0";
        points.forEach(pt=>{
            ctxStitch.fillRect(pt.x, pt.y, 1, 1);
        });
        addLog("تم رسم مسارات الغرز. عدد الغرز: " + points.length);

        // حفظ ملف PES
        fetch(data.pes).then(r=>r.blob()).then(b=>{ pesBlob=b; });
        data.log.forEach(l=>addLog(l));
        addLog("تم تجهيز الملف للتنزيل");
    })
    .catch(err=>{
        console.error(err);
        addLog("حدث خطأ أثناء الاتصال بالسيرفر");
    });
});

// تنزيل الملف
downloadBtn.addEventListener('click', ()=>{
    if(!uploadedFile){ alert("اختر صورة أولاً"); return; }
    if(!pesBlob){ alert("الملف لم يُجهز بعد"); return; }
    const link = document.createElement('a');
    if(downloadFormat.value==="pes"){
        link.href = URL.createObjectURL(pesBlob);
        link.download = (uploadedFile.name.split('.')[0] || 'stitch_pattern')+".pes";
    } else if(downloadFormat.value==="jpg"){
        link.href = canvasProcessed.toDataURL('image/jpeg');
        link.download = (uploadedFile.name.split('.')[0] || 'processed_image')+".jpg";
    } else {
        link.href = canvasProcessed.toDataURL('image/png');
        link.download = (uploadedFile.name.split('.')[0] || 'processed_image')+".png";
    }
    link.click();
    addLog("تم تنزيل الملف بصيغة "+downloadFormat.value.toUpperCase());
});
</script>
</body>
    </html>
