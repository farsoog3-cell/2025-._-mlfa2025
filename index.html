<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>باترون تطريز احترافي</title>
<style>
body { font-family: Arial; text-align:center; background:#111; color:#fff; }
canvas { border:1px solid #000; margin-top:20px; max-width:100%; }
button,input,select { padding:10px; margin:5px; border-radius:5px; }
</style>
</head>
<body>

<h1>تحويل الصورة إلى باترون تطريز احترافي</h1>

<input type="file" id="imageInput" accept="image/*">
<br>
<button id="analyzeBtn">تحليل الصورة واستخراج الغرز</button>
<br>
<canvas id="canvas"></canvas>
<br>
<input type="text" id="fileName" value="stitch_pattern" placeholder="اسم الملف">
<select id="fileType">
  <option value="pes">PES (Brother)</option>
</select>
<button id="downloadBtn">تنزيل الملف</button>
<div id="info"></div>

<script>
const SERVER_URL = "https://2025mlfa-2-7e2x.onrender.com/generate_pes";
const imageInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const fileNameInput = document.getElementById('fileName');
const info = document.getElementById('info');

let img = new Image();
let stitchPoints = [];

// رفع الصورة
imageInput.addEventListener('change', function(){
  const file = this.files[0];
  if(!file) return;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
  img.src = URL.createObjectURL(file);
});

// تحليل الصورة واستخراج الغرز
analyzeBtn.addEventListener('click', () => {
  if(!img.src){ alert("رفع الصورة أولاً"); return; }
  ctx.drawImage(img,0,0);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imageData.data;
  stitchPoints = [];

  const threshold = 128; 
  const step = 3; 

  // استخراج الغرز مع ترتيب منطقي (خطوط متوازية وتتابع)
  for(let y=0; y<canvas.height; y+=step){
    const rowPoints = [];
    for(let x=0; x<canvas.width; x+=step){
      const i = (y*canvas.width + x)*4;
      const gray = 0.3*data[i] + 0.59*data[i+1] + 0.11*data[i+2];
      if(gray < threshold){
        rowPoints.push({x:x, y:y, type:'fill'}); // نوع الغرز Fill للداخل
        ctx.fillStyle = "#0f0";
        ctx.fillRect(x,y,1,1);
      }
    }
    // ترتيب النقاط بشكل zigzag لكل صف
    if(y/step % 2 === 1) rowPoints.reverse();
    stitchPoints.push(...rowPoints);
  }

  info.textContent = `عدد الغرز: ${stitchPoints.length}`;
});

// تنزيل ملف PES
downloadBtn.addEventListener('click', () => {
  if(stitchPoints.length===0){ alert("تحليل الصورة أولاً"); return; }
  const fileName = fileNameInput.value || 'stitch_pattern';

  fetch(SERVER_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({points:stitchPoints})
  })
  .then(res=>res.blob())
  .then(blob=>{
    const link=document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${fileName}.pes`;
    link.click();
    info.textContent = "تم إنشاء الملف بنجاح! جاهز للاختبار في Embroidery Viewer";
  })
  .catch(err=>{
    console.error(err);
    info.textContent = "خطأ أثناء إنشاء الملف";
  });
});
</script>

</body>
</html>
