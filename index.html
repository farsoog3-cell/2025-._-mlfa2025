<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² DST</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body {background:#000;color:#fff;font-family:Arial,sans-serif;text-align:center;}
section{max-width:800px;margin:30px auto;padding:20px;background:#111;border-radius:15px;box-shadow:0 0 15px #333;}
input,button{padding:12px;margin:5px;border-radius:8px;border:none;font-size:1em;}
button{background:#222;color:#fff;cursor:pointer;transition:0.2s;}
button:hover{background:#444;}
#consolePanel,#statsPanel,#colorsPanel{background:#111;border:1px solid #555;max-height:200px;overflow-y:auto;padding:10px;text-align:left;margin-top:15px;font-family:monospace;font-size:0.9em;}
.color-swatch{display:inline-block;width:20px;height:20px;margin:2px;border:1px solid #fff;}
#previewCanvas{border:1px solid #fff;margin-top:20px;max-width:100%;border-radius:8px;}
#status{margin-top:10px;font-weight:bold;color:#0f0;}
</style>
</head>
<body>
<section>
<h1><i class="fa-solid fa-pen-nib"></i> AI ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² DST</h1>

<input type="file" id="imageInput" accept="image/*"><br>
<input type="text" id="fileName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù"><br>
<button id="startBtn"><i class="fa-solid fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
<button id="downloadBtn" disabled><i class="fa-solid fa-download"></i> ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>

<div id="status"></div>

<h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
<div id="consolePanel"></div>

<h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…</h3>
<div id="statsPanel"></div>

<h3>Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØºØ±Ø²</h3>
<div id="colorsPanel"></div>

<h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØºØ±Ø²</h3>
<canvas id="previewCanvas"></canvas>
</section>

<script>
const SERVER_URL="https://2025mlfa-2-7e2x.onrender.com/generate_dst_from_image";

const imageInput=document.getElementById('imageInput');
const fileNameInput=document.getElementById('fileName');
const startBtn=document.getElementById('startBtn');
const downloadBtn=document.getElementById('downloadBtn');
const status=document.getElementById('status');
const consolePanel=document.getElementById('consolePanel');
const statsPanel=document.getElementById('statsPanel');
const colorsPanel=document.getElementById('colorsPanel');
const previewCanvas=document.getElementById('previewCanvas');
const previewCtx=previewCanvas.getContext('2d');

let generatedBlob = null;

function logConsole(msg){consolePanel.innerHTML += msg + "<br>"; consolePanel.scrollTop = consolePanel.scrollHeight;}
function updateStats(stats){statsPanel.innerHTML = ""; for(const key in stats){ statsPanel.innerHTML += `<b>${key}</b>: ${stats[key]}<br>`; }}
function updateColors(colors){colorsPanel.innerHTML=""; colors.forEach(c=>{ const div=document.createElement('div'); div.className="color-swatch"; div.style.backgroundColor=c.hex; div.title="ØºØ±Ø²: "+c.stitches+" - Ø§Ù„Ù„ÙˆÙ†: "+c.hex; colorsPanel.appendChild(div); }); }
function drawPreview(colors){ if(!colors.length) return; previewCanvas.width=500; previewCanvas.height=500; previewCtx.fillStyle="#fff"; previewCtx.fillRect(0,0,previewCanvas.width,previewCanvas.height); colors.forEach(c=>{ previewCtx.fillStyle=c.hex; const count=Math.sqrt(c.stitches); const step=Math.max(1,Math.floor(500/count)); for(let i=0;i<count;i++){ for(let j=0;j<count;j++){ previewCtx.fillRect(i*step,j*step,1,1); } } }); }

startBtn.addEventListener('click',()=>{
    const imageFile=imageInput.files[0];
    if(!imageFile){ alert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); return; }

    const formData=new FormData();
    formData.append("image",imageFile);

    const fileName=fileNameInput.value || "ai_stitch";
    status.textContent="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
    logConsole("ğŸš€ Ø¨Ø¯Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...");
    downloadBtn.disabled = true;
    generatedBlob = null;

    fetch(SERVER_URL,{method:"POST",body:formData})
    .then(async res=>{
        logConsole("âœ… ØªÙ… ØªÙ„Ù‚ÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + res.status);
        if(!res.ok){ const text=await res.text(); throw new Error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù†Ø§Ø¬Ø­Ø©: "+text); }

        const colorsHeader=res.headers.get('X-Colors-Info');
        let colors=[];
        try{ colors=JSON.parse(colorsHeader); }catch(e){ logConsole("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØºØ±Ø²: "+e); }
        updateColors(colors);
        drawPreview(colors);

        const totalStitches=colors.reduce((a,b)=>a+b.stitches,0);
        updateStats({ "Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø² Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ": totalStitches, "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†": colors.length });

        return res.blob();
    })
    .then(blob=>{
        generatedBlob = blob;
        downloadBtn.disabled = false;
        status.textContent="âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©! ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù†.";
        logConsole("ğŸ‰ Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ø²ÙŠÙ„.");
    })
    .catch(err=>{
        console.error(err);
        status.textContent="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.";
        logConsole("âŒ Ø®Ø·Ø£: "+err);
    });
});

downloadBtn.addEventListener('click',()=>{
    if(!generatedBlob) return;
    const fileName = fileNameInput.value || "ai_stitch";
    const link=document.createElement('a');
    link.href=URL.createObjectURL(generatedBlob);
    link.download=fileName+".dst";
    link.click();
});
</script>
</body>
</html>
