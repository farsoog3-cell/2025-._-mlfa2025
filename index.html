<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Embroidery Generator</title>
<style>
  body { background-color: #121212; color: #f0f0f0; font-family: Arial, sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
  h1 { color: #00ff99; }
  input, button { margin: 10px; padding: 10px; border-radius: 8px; border:none; font-size:16px; }
  input[type=file] { background-color: #333; color: #fff; }
  button { background-color: #00ff99; color:#121212; cursor:pointer; }
  button:disabled { background-color: #555; cursor: not-allowed; }
  #status { margin-top: 20px; font-weight:bold; }
</style>
</head>
<body>

<h1>AI Embroidery Generator</h1>
<input type="file" id="imageInput" accept="image/*">
<button id="startBtn">ابدأ المعالجة</button>
<button id="downloadBtn" disabled>تحميل الملف</button>
<div id="status"></div>

<script>
const startBtn = document.getElementById('startBtn');
const downloadBtn = document.getElementById('downloadBtn');
const status = document.getElementById('status');
let lastBlob = null;

startBtn.addEventListener('click', async () => {
    const fileInput = document.getElementById('imageInput');
    if (!fileInput.files.length) { alert('يرجى اختيار صورة'); return; }

    startBtn.disabled = true;
    status.textContent = '⏳ جاري المعالجة...';
    downloadBtn.disabled = true;

    const formData = new FormData();
    formData.append('image', fileInput.files[0]);

    try {
        const response = await fetch('https://2025mlfa-2-7e2x.onrender.com/generate_dst_from_image', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            status.textContent = '❌ خطأ: ' + (error.error || 'فشل الاتصال بالسيرفر');
            startBtn.disabled = false;
            return;
        }

        const blob = await response.blob();
        lastBlob = blob;
        status.textContent = '✅ تم الانتهاء! يمكنك تحميل الملف.';
        downloadBtn.disabled = false;

    } catch (err) {
        status.textContent = '❌ خطأ في الاتصال بالخادم: ' + err.message;
    } finally {
        startBtn.disabled = false;
    }
});

downloadBtn.addEventListener('click', () => {
    if (!lastBlob) return;
    const url = URL.createObjectURL(lastBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai_stitch.dst';
    a.click();
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
