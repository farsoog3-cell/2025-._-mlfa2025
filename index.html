<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mlfa2025.91 - باترونات التطريز</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body {margin:0;font-family:Arial,sans-serif;text-align:center;background-color:#000;color:#fff;}
header {padding:20px;background-color:#111;border-bottom:2px solid #fff;}
section {margin:40px auto;max-width:900px;background-color:#111;padding:20px;border-radius:10px;}
.buttons-container {display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:20px;}
.buttons-container button, input[type="file"], input[type="text"] {padding:10px 15px;font-size:1em;cursor:pointer;border:none;border-radius:5px;transition:0.2s;}
.buttons-container button {background-color:#222;color:#fff;display:flex;align-items:center;gap:5px;}
.buttons-container button:hover {background-color:#444;}
canvas {margin-top:20px;border:1px solid #000;max-width:100%;}
label {margin:0 10px;}
input[type="text"] {width:150px;border-radius:5px;border:1px solid #fff;background-color:#111;color:#fff;}
#stitchInfo {margin-top:10px;font-size:1.1em;color:#0f0;}
</style>
</head>
<body>
<header>
<h1>mlfa2025.91</h1>
</header>

<section>
<h2>رفع الصورة ومعاينة باترونات التطريز</h2>
<div class="buttons-container">
<label><i class="fa-solid fa-image"></i> رفع صورة
<input type="file" id="imageInput" accept="image/*"></label>
<input type="text" id="fileName" value="stitch_pattern" placeholder="اسم الملف">
<button id="downloadBtn"><i class="fa-solid fa-download"></i> تنزيل PES</button>
</div>

<canvas id="canvas"></canvas>
<div id="stitchInfo"></div>
</section>

<script>
const SERVER_URL = "https://2025mlfa-2-7e2x.onrender.com/generate_pes";

const imageInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const downloadBtn = document.getElementById('downloadBtn');
const fileNameInput = document.getElementById('fileName');
const stitchInfo = document.getElementById('stitchInfo');

let img = new Image();
let previewPointsByColor = {};

// عرض الصورة على الكانفاس وعرض معاينة غرز ملونة
imageInput.addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;

    img.onload = ()=>{
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0);

        // إنشاء معاينة نقاط الغرز الملونة
        previewPointsByColor = {};
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const data = imageData.data;
        const step = 2;

        for(let y=0; y<canvas.height; y+=step){
            for(let x=0; x<canvas.width; x+=step){
                const i=(y*canvas.width+x)*4;
                const color = `rgb(${data[i]},${data[i+1]},${data[i+2]})`;
                if(!previewPointsByColor[color]) previewPointsByColor[color]=[];
                previewPointsByColor[color].push({x:x,y:y});
            }
        }

        drawPreview();
    };
    img.src = URL.createObjectURL(file);
});

// رسم معاينة الغرز على الكانفاس
function drawPreview(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    for(const color in previewPointsByColor){
        const points = previewPointsByColor[color];
        ctx.fillStyle=color;
        for(const p of points){
            ctx.fillRect(p.x,p.y,1,1);
        }
    }
}

// تنزيل PES من السيرفر
downloadBtn.addEventListener('click', ()=>{
    const file = imageInput.files[0];
    if(!file){ alert("يرجى رفع صورة أولاً!"); return; }

    const fileName = fileNameInput.value || 'stitch_pattern';
    stitchInfo.textContent = "جارٍ إنشاء ملف PES...";

    const formData = new FormData();
    formData.append('image', file);

    fetch(SERVER_URL, {
        method: 'POST',
        body: formData
    }).then(response => {
        if(!response.ok) throw new Error("حدث خطأ أثناء إنشاء PES");
        return response.blob();
    }).then(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${fileName}.pes`;
        link.click();
        stitchInfo.textContent = "تم إنشاء ملف PES بنجاح!";
    }).catch(err => {
        console.error(err);
        stitchInfo.textContent = "حدث خطأ أثناء إنشاء ملف PES.";
    });
});
</script>
</body>
</html>
