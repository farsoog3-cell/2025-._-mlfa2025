<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI تحويل الصورة إلى تطريز DST</title>
<style>
body {background:#000;color:#fff;font-family:Arial,sans-serif;text-align:center;}
section{max-width:900px;margin:30px auto;padding:20px;background:#111;border-radius:10px;}
input,button{padding:10px;margin:5px;border-radius:5px;border:none;}
button{background:#222;color:#fff;cursor:pointer;}
button:hover{background:#444;}
#consolePanel,#statsPanel,#colorsPanel{background:#111;border:1px solid #555;max-height:200px;overflow-y:auto;padding:10px;text-align:left;margin-top:20px;font-family:monospace;font-size:0.9em;}
.color-swatch{display:inline-block;width:20px;height:20px;margin:2px;border:1px solid #fff;}
#previewCanvas{border:1px solid #fff;margin-top:20px;max-width:100%;}
</style>
</head>
<body>
<section>
<h1>AI تحويل الصورة إلى تطريز DST</h1>

<input type="file" id="imageInput" accept="image/*"><br>
<input type="text" id="fileName" placeholder="اسم الملف"><br>
<button id="downloadBtn">تنزيل ملف DST</button>

<div id="status"></div>

<h3>لوحة التحكم والمعلومات</h3>
<div id="consolePanel"></div>

<h3>إحصائيات التصميم</h3>
<div id="statsPanel"></div>

<h3>الألوان والغرز</h3>
<div id="colorsPanel"></div>

<h3>معاينة الغرز</h3>
<canvas id="previewCanvas"></canvas>
</section>

<script>
const SERVER_URL="https://2025mlfa-2-7e2x.onrender.com/generate_dst_from_image";

const imageInput=document.getElementById('imageInput');
const fileNameInput=document.getElementById('fileName');
const downloadBtn=document.getElementById('downloadBtn');
const status=document.getElementById('status');
const consolePanel=document.getElementById('consolePanel');
const statsPanel=document.getElementById('statsPanel');
const colorsPanel=document.getElementById('colorsPanel');
const previewCanvas=document.getElementById('previewCanvas');
const previewCtx=previewCanvas.getContext('2d');

function logConsole(msg){consolePanel.innerHTML += msg + "<br>"; consolePanel.scrollTop = consolePanel.scrollHeight;}
function updateStats(stats){statsPanel.innerHTML = ""; for(const key in stats){ statsPanel.innerHTML += `<b>${key}</b>: ${stats[key]}<br>`; }}
function updateColors(colors){colorsPanel.innerHTML=""; colors.forEach(c=>{ const div=document.createElement('div'); div.className="color-swatch"; div.style.backgroundColor=c.hex; div.title="غرز: "+c.stitches+" - اللون: "+c.hex; colorsPanel.appendChild(div); }); }
function drawPreview(colors){
    if(!colors.length) return;
    previewCanvas.width = 500;
    previewCanvas.height = 500;
    previewCtx.fillStyle="#fff";
    previewCtx.fillRect(0,0,previewCanvas.width,previewCanvas.height);
    colors.forEach((c,idx)=>{
        previewCtx.fillStyle=c.hex;
        const step=Math.max(1, Math.floor(500/Math.sqrt(c.stitches)));
        for(let i=0;i<Math.sqrt(c.stitches);i++){
            for(let j=0;j<Math.sqrt(c.stitches);j++){
                previewCtx.fillRect(i*step,j*step,1,1);
            }
        }
    });
}

downloadBtn.addEventListener('click',()=>{
    const imageFile=imageInput.files[0];
    if(!imageFile){ alert("يرجى رفع الصورة"); return; }
    const formData=new FormData();
    formData.append("image",imageFile);

    const fileName=fileNameInput.value || "ai_stitch";
    status.textContent="جارٍ إنشاء ملف DST...";
    logConsole("🚀 بدأ إرسال الصورة إلى السيرفر...");
    const startTime = Date.now();

    fetch(SERVER_URL,{method:"POST",body:formData})
    .then(async res=>{
        logConsole("✅ تم تلقي الاستجابة من السيرفر: " + res.status);
        if(!res.ok){ const text = await res.text(); throw new Error("استجابة السيرفر غير ناجحة: "+text); }

        const colorsHeader = res.headers.get('X-Colors-Info');
        let colors = [];
        try{ colors = JSON.parse(colorsHeader.replace(/'/g,'"')); }catch(e){ logConsole("⚠️ خطأ في قراءة ألوان الغرز من الهيدر: "+e); }
        updateColors(colors);
        drawPreview(colors);

        const totalStitches = colors.reduce((a,b)=>a+b.stitches,0);
        updateStats({ "عدد الغرز التقريبي": totalStitches, "عدد الألوان": colors.length, "مدة التحويل": "جارٍ التحويل..." });

        return res.blob();
    })
    .then(blob=>{
        const endTime = Date.now();
        const timeSec = ((endTime - startTime)/1000).toFixed(2);

        const link=document.createElement('a');
        link.href=URL.createObjectURL(blob);
        link.download=fileName+".dst";
        link.click();

        status.textContent="تم إنشاء ملف DST بنجاح!";
        logConsole("🎉 تم تنزيل ملف DST باسم: " + fileName+".dst");

        const colors = Array.from(colorsPanel.children).map((div,index)=>({
            hex:div.style.backgroundColor,
            stitches: parseInt(div.title.split(": ")[1])
        }));
        const totalStitches = colors.reduce((a,b)=>a+b.stitches,0);
        updateStats({ "عدد الغرز التقريبي": totalStitches, "عدد الألوان": colors.length, "مدة التحويل": timeSec + " ثانية" });
    })
    .catch(err=>{
        console.error(err);
        status.textContent="حدث خطأ أثناء إنشاء ملف DST.";
        logConsole("❌ خطأ: " + err);
    });
});
</script>
</body>
</html>
