document.getElementById('undo').onclick=()=>{ strokes.pop(); redraw(); };

// ===== DST الذكي مع توليد نقاط دقيقة =====
const MAX_STEP=0.05;

function interpolatePoints(p1,p2){
    const points=[];
    const dx=p2.x-p1.x;
    const dy=p2.y-p1.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const steps=Math.ceil(dist/MAX_STEP);
    for(let i=1;i<=steps;i++){
        points.push({x:p1.x+dx*i/steps, y:p1.y+dy*i/steps});
    }
    return points;
}

function splitStroke(stroke){
    if(!stroke || stroke.length<2) return stroke;
    const newStroke=[stroke[0]];
    for(let i=1;i<stroke.length;i++){
        const interpolated=interpolatePoints(newStroke[newStroke.length-1], stroke[i]);
        newStroke.push(...interpolated);
    }
    return newStroke;
}

function encodeStep(dx,dy,control){
    let b0=0,b1=0,b2=0;
    function applyAxis(v,axis){
        const sign=v<0?-1:1;
        let absv=Math.abs(Math.round(v));
        const W=[81,27,9,3,1];
        for(const w of W){
            if(absv>=w){
                if(axis==='x'){
                    if(w===1)b0|=(sign>0?0x01:0x02);
                    else if(w===9)b0|=(sign>0?0x04:0x08);
                    else if(w===3)b1|=(sign>0?0x01:0x02);
                    else if(w===27)b1|=(sign>0?0x04:0x08);
                    else if(w===81)b2|=(sign>0?0x20:0x40);
                } else{
                    if(w===1)b0|=(sign>0?0x10:0x20);
                    else if(w===9)b0|=(sign>0?0x40:0x80);
                    else if(w===3)b1|=(sign>0?0x10:0x20);
                    else if(w===27)b1|=(sign>0?0x40:0x80);
                    else if(w===81)b2|=(sign>0?0x04:0x08);
                }
                absv-=w;
            }
        }
    }
    applyAxis(dx,'x'); applyAxis(dy,'y');
    if(control===0)b2|=0x03; else if(control===1)b2|=0x83; else if(control===2)b2|=0x23;
    return [b0&0xFF,b1&0xFF,b2&0xFF];
}

function buildDST(strokes){
    const allPoints=[];
    for(const stroke of strokes){
        const detailed=splitStroke(stroke);
        for(const p of detailed) allPoints.push({x:pxToMM(p.x), y:pxToMM(p.y)});
        allPoints.push(null);
    }
    if(allPoints.length===0) return null;
    let prev=allPoints[0]||{x:0,y:0};
    const bodyBytes=[];
    let first=false;
    for(const pt of allPoints){
        if(pt===null){ bodyBytes.push(...encodeStep(0,0,2)); first=false; continue;}
        const curr=pt;
        if(!first){ const dx=curr.x-prev.x; const dy=curr.y-prev.y; bodyBytes.push(...encodeStep(dx,dy,1)); prev=curr; first=true; continue;}
        const dx=curr.x-prev.x; const dy=curr.y-prev.y;
        bodyBytes.push(...encodeStep(dx,dy,0)); prev=curr;
    }
    bodyBytes.push(0x00,0x00,0xF3);
    const header=new Uint8Array(512); header.fill(0x20); const name='JS_DST_1to1'; for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
    const buf=new Uint8Array(512+bodyBytes.length); buf.set(header,0); buf.set(new Uint8Array(bodyBytes),512); return buf.buffer;
}

document.getElementById('export-dst').onclick=()=>{
    if(strokes.length===0){ alert('ارسم شيئًا أولاً'); return;}
    const buf=buildDST(strokes); if(!buf){ alert('خطأ في إنشاء الملف'); return;}
    const blob=new Blob([buf],{type:'application/octet-stream'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='design_true_1to1.dst';
    a.click();
    URL.revokeObjectURL(url);
};

redraw();
</script>
</body>
</html>
