<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تحويل صورة إلى ملف تطريز PES</title>
<style>
  body{background:#000;color:#fff;font-family:Arial;text-align:center;margin:0;padding:10px}
  .card{max-width:800px;margin:18px auto;padding:16px;background:#111;border-radius:8px}
  input,button{padding:8px;margin:6px;border-radius:6px;border:none}
  canvas{display:block;margin:12px auto;border:1px solid #333;max-width:100%}
  #info{color:#0f0}
</style>
</head>
<body>
  <div class="card">
    <h2>🧵 تحويل صورة إلى PES (غرز حقيقية)</h2>
    <input type="file" id="imageInput" accept="image/*"><br>
    <label>طول الغرزة: <input id="stitch_length" value="6"></label>
    <label>المسافة: <input id="fill_spacing" value="6"></label>
    <label>أقل مساحة: <input id="min_area" value="100"></label><br>
    <button id="convertBtn">🔁 تحويل وتنزيل PES</button>
    <div id="info"></div>
    <canvas id="preview"></canvas>
  </div>

<script>
const preview = document.getElementById('preview');
const pctx = preview.getContext('2d');
let loadedImage = null;

document.getElementById('imageInput').addEventListener('change', function(){
  const f = this.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = () => {
    preview.width = img.width;
    preview.height = img.height;
    pctx.fillStyle="#fff"; pctx.fillRect(0,0,img.width,img.height);
    pctx.drawImage(img,0,0);
    loadedImage = f;
  }
  img.src = url;
});

document.getElementById('convertBtn').addEventListener('click', async ()=>{
  if(!loadedImage){ alert("اختر صورة أولاً"); return; }
  const fd = new FormData();
  fd.append('image', loadedImage);
  fd.append('stitch_length', document.getElementById('stitch_length').value);
  fd.append('fill_spacing', document.getElementById('fill_spacing').value);
  fd.append('min_contour_area', document.getElementById('min_area').value);

  const info = document.getElementById('info');
  info.textContent = "⏳ جارٍ المعالجة...";

  try {
    const res = await fetch('http://127.0.0.1:5000/image_to_pes', {method:'POST', body:fd});
    if(!res.ok){
      const data = await res.json().catch(()=>({error:'خطأ مجهول'}));
      throw new Error(data.error);
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'output.pes';
    a.click();
    info.textContent = "✅ تم إنشاء PES بنجاح.";
  } catch(err){
    console.error(err);
    info.textContent = "❌ خطأ: " + err.message;
  }
});
</script>
</body>
</html>
