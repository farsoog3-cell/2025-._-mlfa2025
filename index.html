<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>محول صورة إلى DST AI مباشر</title>
<style>
body, html { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#f5f5f7; display:flex; flex-direction:column; height:100%; }
header { background: linear-gradient(90deg,#4b6cb7,#182848); color:#fff; text-align:center; padding:20px; font-size:1.5em; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
#main { flex:1; display:flex; justify-content:center; align-items:center; padding:20px; }
canvas { background:#fff; border:2px solid #ccc; border-radius:15px; }
.controls { display:flex; justify-content:center; padding:15px; flex-wrap:wrap; background:#fff; border-top:1px solid #ddd; box-shadow:0 -2px 5px rgba(0,0,0,0.1);}
button,input { margin:5px; padding:10px 15px; border:none; border-radius:12px; cursor:pointer; font-size:1em; }
button { background:linear-gradient(90deg,#4b6cb7,#182848); color:#fff; transition:0.3s; }
button:hover { background:linear-gradient(90deg,#182848,#4b6cb7); }
.warn { color:#d00; margin-left:10px; font-size:0.9em; }
</style>
</head>
<body>
<header>محول صورة إلى DST مباشر AI</header>
<div id="main">
    <canvas id="board" width="600" height="600"></canvas>
</div>
<div class="controls">
    <button id="clear">مسح اللوحة</button>
    <button id="export-dst">تصدير DST</button>
    <input type="file" id="upload" accept="image/*">
    <div class="warn">يتم إنشاء مخطط خيوط ذكي واحترافي قبل التصدير</div>
</div>

<script>
const API_KEY = "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";

const board = document.getElementById('board');
const ctx = board.getContext('2d');
let strokes = [];

function pxToMM(px){ return px; }

function buildDST(stitches){
    if(!stitches || stitches.length===0) return null;
    const MAX_STEP=1;
    const encodeStep=(dx,dy,control)=>{
        let b0=0,b1=0,b2=0;
        function applyAxis(v,axis){
            const sign=v<0?-1:1; let absv=Math.abs(v);
            const W=[81,27,9,3,1];
            for(const w of W){
                if(absv>=w){
                    if(axis==='x'){ 
                        if(w===1)b0|=(sign>0?0x01:0x02);
                        else if(w===9)b0|=(sign>0?0x04:0x08);
                        else if(w===3)b1|=(sign>0?0x01:0x02);
                        else if(w===27)b1|=(sign>0?0x04:0x08);
                        else if(w===81)b2|=(sign>0?0x20:0x40);
                    } else {
                        if(w===1)b0|=(sign>0?0x10:0x20);
                        else if(w===9)b0|=(sign>0?0x40:0x80);
                        else if(w===3)b1|=(sign>0?0x10:0x20);
                        else if(w===27)b1|=(sign>0?0x40:0x80);
                        else if(w===81)b2|=(sign>0?0x04:0x08);
                    }
                    absv-=w;
                }
            }
        }
        applyAxis(dx,'x'); applyAxis(dy,'y');
        if(control===0)b2|=0x03; else if(control===1)b2|=0x83; else if(control===2)b2|=0x23;
        return [b0&0xFF,b1&0xFF,b2&0xFF];
    }

    const bodyBytes=[];
    let prev=stitches[0];
    for(const curr of stitches){
        const dx=curr.x-prev.x;
        const dy=curr.y-prev.y;
        bodyBytes.push(...encodeStep(dx,dy,0));
        prev=curr;
    }
    bodyBytes.push(0x00,0x00,0xF3);

    const header=new Uint8Array(512); header.fill(0x20);
    const name='MLFA2025.99';
    for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
    const buf=new Uint8Array(512+bodyBytes.length);
    buf.set(header,0);
    buf.set(new Uint8Array(bodyBytes),512);
    return buf.buffer;
}

// ==== إرسال الصورة مباشرة إلى OpenAI ====
async function sendToAI(imageBase64){
    const response = await fetch("https://api.openai.com/v1/responses", {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+API_KEY
        },
        body: JSON.stringify({
            model: "gpt-4.1-mini",
            input: `حول هذه الصورة إلى مخطط DST احترافي JSON من نقاط الإبرة: ${imageBase64}`
        })
    });
    const data = await response.json();
    // توقع أن النموذج يعطي JSON مباشرة
    try { 
        return JSON.parse(data.output_text || data.output[0].content[0].text); 
    } catch(e){ 
        alert("خطأ في قراءة البيانات من AI"); 
        return [];
    }
}

document.getElementById('upload').addEventListener('change', async function(e){
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async function(ev){
        const imageBase64 = ev.target.result.split(',')[1];

        strokes = await sendToAI(imageBase64);

        // رسم المخطط
        ctx.clearRect(0,0,board.width,board.height);
        ctx.strokeStyle='#000';
        ctx.lineWidth=1;
        ctx.lineJoin='round';
        ctx.lineCap='round';
        if(strokes.length>0){
            ctx.beginPath(); ctx.moveTo(strokes[0].x,strokes[0].y);
            for(let i=1;i<strokes.length;i++) ctx.lineTo(strokes[i].x,strokes[i].y);
            ctx.stroke();
        }
    };
    reader.readAsDataURL(file);
});

document.getElementById('clear').onclick = ()=>{ strokes=[]; ctx.clearRect(0,0,board.width,board.height); };
document.getElementById('export-dst').onclick = ()=>{
    if(strokes.length===0){ alert('ارفع صورة أولاً'); return; }
    const buf = buildDST(strokes); if(!buf){ alert('خطأ في إنشاء الملف'); return; }
    const blob = new Blob([buf], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download='mlfa2025.99.dst';
    a.click();
    URL.revokeObjectURL(url);
};
</script>
</body>
</html>
