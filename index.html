<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MLFA - مصمم قوالب التطريز</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; display:flex; flex-direction:column; min-height:100vh;}
h1 { font-size:28px; margin:15px 0; text-align:center;}
.container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:10px; flex:1;}
.tools { flex:0 0 280px; background:#111; padding:15px; border-radius:12px; display:flex; flex-direction:column; gap:10px;}
.tools label { display:flex; flex-direction:column; font-weight:bold; }
.tools input, .tools select { margin-top:5px; padding:5px; border-radius:6px; border:1px solid #fff; background:#222; color:#fff;}
button { padding:10px; background:#2563eb; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
button:hover { background:#1d4ed8;}
#canvasContainer { flex:1; min-width:300px; max-width:900px; background:#111; padding:10px; border-radius:12px;}
canvas, #viewerContainer { width:100%; height:600px; border-radius:12px; background:#222; display:block; margin-bottom:10px;}
footer { text-align:center; font-size:14px; color:#aaa; padding:10px;}
</style>
</head>
<body>

<h1>MLFA - مصمم قوالب التطريز</h1>

<div class="container">
  <div class="tools">
    <label>رفع صورة: <input type="file" id="uploadImage" accept="image/*"></label>
    <button id="startFromImage">ابدأ من الصورة</button>
    <label>لون الخيط: <input type="color" id="threadColor" value="#FF0000"></label>
    <label>سمك الخيط: <input type="number" id="threadSize" value="2" min="1" max="10"></label>
    <label>طول الغرزة: <input type="number" id="stitchLength" value="5" min="1" max="20"></label>
    <label>نوع القماش:
      <select id="fabricType">
        <option value="cotton">قطن</option>
        <option value="linen">كتان</option>
        <option value="silk">حرير</option>
      </select>
    </label>
    <button id="resetCanvas">مسح اللوح</button>
    <button id="downloadPNG">تنزيل PNG</button>
    <button id="downloadDST">تنزيل DST</button>
  </div>

  <div id="canvasContainer">
    <canvas id="embroideryCanvas" width="800" height="600"></canvas>
    <div id="viewerContainer"></div>
  </div>
</div>

<footer>موقع: MLFA | المطورين: فارس وملهم</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// المتغيرات الأساسية
const canvas = document.getElementById('embroideryCanvas');
const ctx = canvas.getContext('2d');
const viewerContainer = document.getElementById('viewerContainer');

const threadColor = document.getElementById('threadColor');
const threadSize = document.getElementById('threadSize');
const stitchLength = document.getElementById('stitchLength');
const fabricType = document.getElementById('fabricType');
const uploadImage = document.getElementById('uploadImage');
const downloadPNG = document.getElementById('downloadPNG');
const downloadDST = document.getElementById('downloadDST');
const resetCanvas = document.getElementById('resetCanvas');
const startFromImage = document.getElementById('startFromImage');

let drawing=false, points=[], bgImage=null, stitchData=[], lastColor=null;

// ألوان الخيوط
const threadPalette = ['#000','#333','#666','#999','#CCC','#FFF','#F00','#0F0','#00F'];
function closestThreadColor(color){
    let r=parseInt(color.slice(1,3),16), g=parseInt(color.slice(3,5),16), b=parseInt(color.slice(5,7),16);
    let minDiff=Infinity, chosen=threadPalette[0];
    threadPalette.forEach(c=>{
        let cr=parseInt(c.slice(1,3),16), cg=parseInt(c.slice(3,5),16), cb=parseInt(c.slice(5,7),16);
        let diff=Math.abs(r-cr)+Math.abs(g-cg)+Math.abs(b-cb);
        if(diff<minDiff){minDiff=diff; chosen=c;}
    });
    return chosen;
}

// إعداد القماش
function setCanvasBackground(){
    ctx.fillStyle = fabricType.value==='cotton'?'#222':fabricType.value==='linen'?'#333':'#111';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    if(bgImage) ctx.drawImage(bgImage,0,0,canvas.width,canvas.height);
}
setCanvasBackground();

// الرسم اليدوي
canvas.addEventListener('mousedown', e=>{drawing=true; points.push({x:e.offsetX,y:e.offsetY});});
canvas.addEventListener('mousemove', e=>{
    if(!drawing) return;
    const last=points[points.length-1];
    const x=e.offsetX, y=e.offsetY;
    ctx.strokeStyle=threadColor.value;
    ctx.lineWidth=parseInt(threadSize.value);
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y);
    ctx.setLineDash([parseInt(stitchLength.value),parseInt(stitchLength.value)]);
    ctx.stroke();
    points.push({x,y});
    stitchData.push({x:x,y:y,color:threadColor.value,width:parseInt(threadSize.value),length:parseInt(stitchLength.value)});
});
canvas.addEventListener('mouseup', ()=>{drawing=false; points=[];});
canvas.addEventListener('mouseleave', ()=>{drawing=false; points=[];});
fabricType.addEventListener('change', setCanvasBackground);

// رفع صورة
uploadImage.addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const img=new Image();
    img.onload=()=>{ bgImage=img; setCanvasBackground(); }
    img.src=URL.createObjectURL(file);
});

// مسح اللوح
resetCanvas.addEventListener('click', ()=>{ bgImage=null; stitchData=[]; setCanvasBackground(); });

// تنزيل PNG
downloadPNG.addEventListener('click', ()=>{ const link=document.createElement('a'); link.download='embroidery.png'; link.href=canvas.toDataURL(); link.click(); });

// توليد DST مبسط
downloadDST.addEventListener('click', ()=>{
    const stitchBinary=[];
    const pushByte=b=>stitchBinary.push(b&0xFF);
    for(let i=0;i<512;i++) pushByte(0x20);
    lastColor=null;
    stitchData.forEach(p=>{
        let color=closestThreadColor(p.color);
        if(color!==lastColor){ pushByte(0xFE); lastColor=color; }
        let x=Math.round(p.x*10), y=Math.round(p.y*10);
        pushByte(x&0xFF); pushByte((x>>8)&0xFF); pushByte(y&0xFF); pushByte((y>>8)&0xFF);
    });
    pushByte(0x1A);
    const blob=new Blob([new Uint8Array(stitchBinary)],{type:'application/octet-stream'});
    const link=document.createElement('a'); link.download='embroidery.dst'; link.href=URL.createObjectURL(blob); link.click();
});

// تحويل الصورة إلى غرز
startFromImage.addEventListener('click', ()=>{
    if(!bgImage){ alert('يرجى رفع صورة أولاً'); return; }
    drawing=false; points=[]; stitchData=[];
    const tempCanvas=document.createElement('canvas'); tempCanvas.width=canvas.width; tempCanvas.height=canvas.height;
    const tctx=tempCanvas.getContext('2d'); tctx.drawImage(bgImage,0,0,canvas.width,canvas.height);
    const imgData=tctx.getImageData(0,0,canvas.width,canvas.height);
    const data=imgData.data; const step=5;
    for(let y=0;y<canvas.height;y+=step){
        for(let x=0;x<canvas.width;x+=step){
            const idx=(y*canvas.width+x)*4;
            const r=data[idx],g=data[idx+1],b=data[idx+2];
            const brightness=(r+g+b)/3;
            let color=brightness>200?'#FFF':brightness>150?'#CCC':brightness>100?'#999':brightness>50?'#666':'#000';
            color=closestThreadColor(color);
            stitchData.push({x,y,color,width:parseInt(threadSize.value),length:parseInt(stitchLength.value)});
        }
    }
    setCanvasBackground();
    stitchData.forEach(p=>{ ctx.strokeStyle=p.color; ctx.lineWidth=p.width; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x+1,p.y+1); ctx.stroke(); });
    renderViewer();
    alert('تم إنشاء مسارات غرز من الصورة.');
});

// Viewer باستخدام Three.js
function renderViewer(){
    viewerContainer.innerHTML='';
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(75, viewerContainer.clientWidth/viewerContainer.clientHeight,0.1,1000);
    const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(viewerContainer.clientWidth,viewerContainer.clientHeight);
    viewerContainer.appendChild(renderer.domElement);

    const geometry=new THREE.BufferGeometry();
    const positions=[], colors=[];
    stitchData.forEach(p=>{
        positions.push(p.x/100, p.y/100, 0);
        const c=new THREE.Color(p.color); colors.push(c.r,c.g,c.b);
    });
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions,3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));

    const material=new THREE.PointsMaterial({size:0.02, vertexColors:true});
    const pointsObj=new THREE.Points(geometry, material);
    scene.add(pointsObj);
    camera.position.z=5;

    function animate(){ requestAnimationFrame(animate); pointsObj.rotation.z+=0.001; renderer.render(scene,camera);}
    animate();
}
</script>

</body>
</html>
