<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mlfa2025 - تسجيل الدخول</title>
<style>
:root{
  --purple:#6b21a8;
  --purple-dark:#4b116f;
  --white:#ffffff;
  --muted:#7b6f95;
  --success:#2a9d8f;
  --danger:#e54b6a;
  --card-shadow:0 10px 30px rgba(107,33,168,0.12);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Segoe UI",Tajawal,system-ui;background:linear-gradient(180deg,var(--purple) 0%, #8b3bd9 100%);color:#111;height:100vh;display:flex;align-items:center;justify-content:center}
.container{background:var(--white);border-radius:12px;padding:28px;max-width:420px;width:100%;box-shadow:var(--card-shadow);text-align:center}
h1{margin-bottom:20px;color:var(--purple-dark)}
input{width:100%;padding:12px;border-radius:10px;border:1px solid #eee;margin:8px 0;font-size:1rem}
button{width:100%;padding:12px;border-radius:10px;border:none;background:var(--purple);color:var(--white);font-weight:600;cursor:pointer;transition:0.3s;font-size:1rem}
button:hover{background:var(--purple-dark)}
.message{margin-top:12px;font-size:0.95rem}
.success{color:var(--success)}
.error{color:var(--danger)}
</style>
</head>
<body>

<div class="container">
  <h1>mlfa2025</h1>
  <input type="text" id="userKey" placeholder="أدخل مفتاح الاشتراك">
  <button id="loginBtn">دخول</button>
  <div id="msg" class="message"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, get, child, set } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD0Hh1e5lq4yfKO9iIPStC6wFfUgXH-6ps",
  authDomain: "fsgsvsb-3af4e.firebaseapp.com",
  databaseURL: "https://fsgsvsb-3af4e-default-rtdb.firebaseio.com",
  projectId: "fsgsvsb-3af4e",
  storageBucket: "fsgsvsb-3af4e.firebasestorage.app",
  messagingSenderId: "740413309189",
  appId: "1:740413309189:web:86aa992833f1452d8d376c",
  measurementId: "G-TBP47X82ZE"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const KEYS_PATH = 'keys';
const SESSIONS_PATH = 'sessions';

const userKeyInput = document.getElementById('userKey');
const loginBtn = document.getElementById('loginBtn');
const msgDiv = document.getElementById('msg');

loginBtn.addEventListener('click', async () => {
  const key = (userKeyInput.value||'').trim();
  if(!key){ showMsg('يرجى إدخال المفتاح', true); return; }

  loginBtn.disabled = true;
  loginBtn.textContent = 'جارٍ التحقق...';

  try{
    const snap = await get(child(ref(db),`${KEYS_PATH}/${key}`));
    if(!snap.exists()){ showMsg('المفتاح غير صحيح', true); resetBtn(); return; }

    const data = snap.val();
    const now = Date.now();
    if(data.expiresAt && data.expiresAt<=now){ showMsg('المفتاح منتهي', true); resetBtn(); return; }

    const sessionSnap = await get(child(ref(db),`${SESSIONS_PATH}/${key}`));
    if(sessionSnap.exists() && sessionSnap.val().deviceId){ 
      showMsg('المفتاح مستخدم على جهاز آخر', true); resetBtn(); return; 
    }

    const deviceId = crypto.randomUUID();
    await set(ref(db,`${SESSIONS_PATH}/${key}`),{deviceId, loginAt:now});
    sessionStorage.setItem('mlfa2025_userKey',key);
    sessionStorage.setItem('mlfa2025_deviceId',deviceId);

    showMsg('تم تسجيل الدخول بنجاح', false);
    setTimeout(()=>{ location.href='drawing.html'; },800);

  }catch(err){
    console.error(err);
    showMsg('حدث خطأ أثناء تسجيل الدخول', true);
  }finally{
    resetBtn();
  }
});

function showMsg(text, isError=false){
  msgDiv.textContent = text;
  msgDiv.classList.remove('error','success');
  msgDiv.classList.add(isError ? 'error' : 'success');
}
function resetBtn(){
  loginBtn.disabled = false;
  loginBtn.textContent = 'دخول';
}
</script>

</body>
</html>
