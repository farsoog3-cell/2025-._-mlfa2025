<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولد ملف DST بسيط</title>
  <style>
    body{font-family:sans-serif;max-width:800px;margin:auto;padding:20px;background:#f9f9f9}
    canvas{border:1px solid #ccc;touch-action:none}
    .controls{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    button{padding:6px 12px}
  </style>
</head>
<body>
  <h1>صفحة توليد ملف <code>.DST</code> (تجريبية)</h1>
  <canvas id="board" width="600" height="400"></canvas>
  <div class="controls">
    <button id="undo">تراجع</button>
    <button id="clear">مسح</button>
    <button id="export-json">تصدير JSON</button>
    <button id="export-dst">تصدير ملف DST</button>
  </div>
  <p>ارسم بالماوس أو اللمس. ثم صدّر ملف DST مبسط (للتجربة فقط، ليس صيغة صناعية مكتملة).</p>
<script>
(() => {
  const canvas = document.getElementById('board');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let points = [];
  let currentStroke = [];

  function start(x,y){
    drawing = true;
    currentStroke = [{x,y}];
  }
  function move(x,y){
    if(!drawing) return;
    currentStroke.push({x,y});
    redraw();
  }
  function end(){
    if(!drawing) return;
    drawing = false;
    if(currentStroke.length>0){
      points.push(currentStroke);
    }
    currentStroke = [];
  }

  function redraw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth=2;
    ctx.strokeStyle="#000";
    ctx.lineJoin="round";
    ctx.lineCap="round";
    function drawStroke(stroke){
      if(stroke.length<2) return;
      ctx.beginPath();
      ctx.moveTo(stroke[0].x, stroke[0].y);
      for(let i=1;i<stroke.length;i++){
        ctx.lineTo(stroke[i].x, stroke[i].y);
      }
      ctx.stroke();
    }
    for(const s of points) drawStroke(s);
    drawStroke(currentStroke);
  }

  canvas.addEventListener('mousedown', e=>{
    const r=canvas.getBoundingClientRect();
    start(e.clientX-r.left, e.clientY-r.top);
  });
  canvas.addEventListener('mousemove', e=>{
    if(!drawing) return;
    const r=canvas.getBoundingClientRect();
    move(e.clientX-r.left, e.clientY-r.top);
  });
  window.addEventListener('mouseup', end);

  canvas.addEventListener('touchstart', e=>{
    e.preventDefault();
    const t=e.touches[0];const r=canvas.getBoundingClientRect();
    start(t.clientX-r.left, t.clientY-r.top);
  },{passive:false});
  canvas.addEventListener('touchmove', e=>{
    e.preventDefault();
    const t=e.touches[0];const r=canvas.getBoundingClientRect();
    move(t.clientX-r.left, t.clientY-r.top);
  },{passive:false});
  canvas.addEventListener('touchend', e=>{
    e.preventDefault();end();
  },{passive:false});

  document.getElementById('clear').onclick=()=>{points=[];currentStroke=[];redraw();}
  document.getElementById('undo').onclick=()=>{points.pop();redraw();}

  document.getElementById('export-json').onclick=()=>{
    const blob=new Blob([JSON.stringify(points)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="design.json";a.click();URL.revokeObjectURL(url);
  }

  document.getElementById('export-dst').onclick=()=>{
    // NOTE: very simplified DST-like format (not real Tajima)
    let data="SIMPLE DST FILE\n";
    for(const stroke of points){
      data+="STROKE\n";
      for(const p of stroke){
        data+=p.x+","+p.y+"\n";
      }
    }
    const blob=new Blob([data],{type:"text/plain"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="design.dst";a.click();URL.revokeObjectURL(url);
  }

  redraw();
})();
</script>
</body>
</html>
