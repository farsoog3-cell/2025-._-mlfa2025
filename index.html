<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>توليد مسار التطريز بالذكاء الاصطناعي</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #000;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    input[type="file"] { margin: 20px 0; }
    button {
        background-color: #fff;
        color: #000;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        margin: 10px;
        font-weight: bold;
        border-radius: 5px;
    }
    button:hover { background-color: #ddd; }
    #canvasContainer {
        position: relative;
        margin-top: 20px;
        max-width: 100%;
    }
    canvas { display: block; max-width: 100%; border: 2px solid #fff; }
    .downloads { margin-top: 20px; }
</style>
</head>
<body>

<h1>توليد مسار التطريز بالذكاء الاصطناعي</h1>

<input type="file" id="imageInput" accept="image/*">
<button id="generateBtn">توليد مسار التطريز</button>

<div id="canvasContainer">
    <canvas id="canvas"></canvas>
</div>

<div class="downloads">
    <a id="downloadImgLink" href="#" download="embroidery-pattern.png">
        <button>تنزيل القالب كصورة</button>
    </a>
    <a id="downloadJSONLink" href="#" download="embroidery-path.json">
        <button>تنزيل مسار الإبرة (JSON)</button>
    </a>
</div>

<script>
const imageInput = document.getElementById('imageInput');
const generateBtn = document.getElementById('generateBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const downloadImgLink = document.getElementById('downloadImgLink');
const downloadJSONLink = document.getElementById('downloadJSONLink');

let uploadedFile;

imageInput.addEventListener('change', (e) => {
    uploadedFile = e.target.files[0];
    if(!uploadedFile) return;

    const reader = new FileReader();
    reader.onload = () => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(uploadedFile);
});

generateBtn.addEventListener('click', async () => {
    if(!uploadedFile) {
        alert("يرجى رفع صورة أولاً!");
        return;
    }

    generateBtn.disabled = true;
    generateBtn.textContent = "جارٍ توليد مسار التطريز...";

    const reader = new FileReader();
    reader.onload = async () => {
        const base64Image = reader.result.split(',')[1];

        try {
            // مثال على استدعاء API OpenAI لإنشاء مسار التطريز
            const response = await fetch("https://api.openai.com/v1/images/edits", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer YOUR_OPENAI_API_KEY",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "gpt-image-1",
                    image: base64Image,
                    prompt: "حول هذه الصورة إلى قالب خطوط للتطريز، مع مسار الإبرة وألوان الخيط"
                })
            });

            const data = await response.json();
            // افترض أن API تعطي صورة القالب base64 وJSON للمسار
            const generatedBase64 = data.data[0].b64_json; 
            const embroideryJSON = {
                path: [[0,0],[10,10],[20,15]], // مثال وهمي
                colors: ["#FF0000","#00FF00","#0000FF"]
            };

            // عرض القالب على الكانفس
            const img = new Image();
            img.onload = () => { ctx.drawImage(img,0,0); };
            img.src = "data:image/png;base64," + generatedBase64;

            // تنزيل صورة القالب
            downloadImgLink.href = "data:image/png;base64," + generatedBase64;

            // تنزيل JSON لمسار الإبرة
            const jsonBlob = new Blob([JSON.stringify(embroideryJSON, null, 2)], {type:"application/json"});
            downloadJSONLink.href = URL.createObjectURL(jsonBlob);

        } catch (err) {
            alert("حدث خطأ أثناء توليد القالب: " + err.message);
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = "توليد مسار التطريز";
        }
    };

    reader.readAsDataURL(uploadedFile);
});
</script>

</body>
</html>
