<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø®Ø±ÙŠØ·Ø© ØªØ·Ø±ÙŠØ² Ø°ÙƒÙŠØ© Ù…Ø¹ ØªØµØ¯ÙŠØ± DST</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI',sans-serif; display:flex; flex-direction:column; background:#f0f2f5;}
header { background: linear-gradient(90deg,#4b6cb7,#182848); color:#fff; text-align:center; padding:15px 0; font-size:1.4em; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
#main { flex:1 1 auto; display:flex; justify-content:center; align-items:center; padding:20px;}
canvas { display:block; background:#fff; border-radius:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); border:2px solid #ccc;}
#board { width:80vmin; height:80vmin;}
.controls { flex:0 0 auto; padding:10px; background:#fff; display:flex; justify-content:center; align-items:center; border-top:2px solid #ddd; box-shadow:0 -2px 5px rgba(0,0,0,0.05); flex-wrap:wrap;}
button, input { padding:8px 12px; margin:5px; border-radius:12px; border:none; cursor:pointer; transition:0.3s; }
button { background:#4b6cb7; color:#fff; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
button:hover { background:#182848;}
input[type=file] { cursor:pointer; }
.warn { color:#d00; font-size:0.85em; margin-left:15px; }

/* Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Ø§Ø­ØªØ±Ø§ÙÙŠ */
.upload-label {
    background: linear-gradient(90deg,#4b6cb7,#182848);
    color: #fff;
    padding: 10px 18px;
    margin: 5px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.upload-label:hover {
    background: #182848;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}
#file-name {
    font-size: 0.9em;
    color: #333;
    margin-right: 10px;
}

/* Ø§Ù„Ø³ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠØ© */
.bio-title {
    text-align: center;
    font-size: 1.4em;
    font-weight: bold;
    margin: 25px 0 15px;
    color: #182848;
}

.devs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    padding: 10px 20px 30px;
}

.dev-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    width: 280px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.dev-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.dev-card h3 {
    margin: 0 0 10px;
    color: #4b6cb7;
    font-size: 1.2em;
}

.dev-card .role {
    font-size: 0.9em;
    font-weight: bold;
    color: #555;
    margin-bottom: 10px;
}

.dev-card ul {
    margin: 0;
    padding-left: 18px;
    font-size: 0.9em;
    line-height: 1.5em;
    color: #333;
}
</style>
</head>
<body>
<header>mlfa2025.89</header>

<div id="main"><canvas id="board"></canvas></div>

<div class="controls">
    <button id="clear">Ù…Ø³Ø­</button>
    <button id="export-dst">ØªØµØ¯ÙŠØ± DST</button>

    <!-- Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Ø§Ø­ØªØ±Ø§ÙÙŠ -->
    <label for="upload" class="upload-label">ğŸ“‚ Ø±ÙØ¹ ØµÙˆØ±Ø©</label>
    <input type="file" id="upload" accept="image/*" hidden>
    <span id="file-name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>

    <div class="warn">Ø§Ù„ØµÙˆØ±Ø© ØªØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ² Ù…ÙÙ‡ÙˆÙ… Ù„Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.</div>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© -->
<div class="bio-title">Ø³ÙŠØ± Ø°Ø§ØªÙŠØ© â€” ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>
<div class="devs">
    <div class="dev-card">
        <h3>ÙØ§Ø±Ø³</h3>
        <div class="role">Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Front-end / UX)</div>
        <ul>
            <li>Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ù‡Ø§Øª Ø£Ù…Ø§Ù…ÙŠØ© Ø¨Ø®Ø¨Ø±Ø© ÙÙŠ HTML/CSS/JavaScript ÙˆCanvas.</li>
            <li>ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ¬Ø§ÙˆØ¨Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</li>
            <li>Ø³Ø§Ù‡Ù… ÙÙŠ Ø¨Ù†Ø§Ø¡ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø³Ù…ØŒ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</li>
            <li>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª: ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</li>
        </ul>
    </div>

    <div class="dev-card">
        <h3>Ù…Ù„Ù‡Ù…</h3>
        <div class="role">Ø§Ù„Ø£Ø¯Ø§Ø¡ (Performance / Algorithm)</div>
        <ul>
            <li>Ù…ØªØ®ØµØµ ÙÙŠ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·Ø±ÙŠØ².</li>
            <li>Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§ØªØŒ ÙˆØªØ±Ù…ÙŠØ² DST Ø¨ÙƒÙØ§Ø¡Ø©.</li>
            <li>ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… ÙˆÙ…Ø¹Ø¯Ù„ Ø§Ù„ØºØ±Ø².</li>
            <li>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ¯Ù‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„.</li>
        </ul>
    </div>
</div>

<script>
const board=document.getElementById('board');
const ctx=board.getContext('2d');
let strokes=[];
let BOARD_MM=200;
let PX_PER_MM=1;

function resizeCanvas(){
    board.width=board.clientWidth;
    board.height=board.clientHeight;
    PX_PER_MM=board.width/BOARD_MM;
}
window.addEventListener('load',resizeCanvas);
window.addEventListener('resize',resizeCanvas);

function pxToMM(px){ return px/PX_PER_MM; }

// ===== DST Encoding =====
const MAX_STEP=1;
function splitStep(dx,dy){
    const steps=[]; let rx=dx, ry=dy;
    while(Math.abs(rx)>MAX_STEP || Math.abs(ry)>MAX_STEP){
        const sx=Math.max(-MAX_STEP,Math.min(MAX_STEP,rx));
        const sy=Math.max(-MAX_STEP,Math.min(MAX_STEP,ry));
        steps.push([sx,sy]); rx-=sx; ry-=sy;
    }
    steps.push([rx,ry]); return steps;
}

function encodeStep(dx,dy,control){
    let b0=0,b1=0,b2=0;
    function applyAxis(v,axis){
        const sign=v<0?-1:1;
        let absv=Math.abs(v);
        const W=[81,27,9,3,1];
        for(const w of W){
            if(absv>=w){
                if(axis==='x'){
                    if(w===1)b0|=(sign>0?0x01:0x02);
                    else if(w===9)b0|=(sign>0?0x04:0x08);
                    else if(w===3)b1|=(sign>0?0x01:0x02);
                    else if(w===27)b1|=(sign>0?0x04:0x08);
                    else if(w===81)b2|=(sign>0?0x20:0x40);
                }else{
                    if(w===1)b0|=(sign>0?0x10:0x20);
                    else if(w===9)b0|=(sign>0?0x40:0x80);
                    else if(w===3)b1|=(sign>0?0x10:0x20);
                    else if(w===27)b1|=(sign>0?0x40:0x80);
                    else if(w===81)b2|=(sign>0?0x04:0x08);
                }
                absv-=w;
            }
        }
    }
    applyAxis(dx,'x'); applyAxis(dy,'y');
    if(control===0)b2|=0x03;
    else if(control===1)b2|=0x83;
    else if(control===2)b2|=0x23;
    return [b0&0xFF,b1&0xFF,b2&0xFF];
}

function buildDST(strokes){
    const allPoints=[];
    for(const stroke of strokes){
        for(const p of stroke) allPoints.push({x:pxToMM(p.x),y:pxToMM(p.y)});
        allPoints.push(null);
    }
    if(allPoints.length===0) return null;
    let prev=allPoints[0]||{x:0,y:0};
    const bodyBytes=[]; let first=false;
    for(const pt of allPoints){
        if(pt===null){ bodyBytes.push(...encodeStep(0,0,2)); first=false; continue; }
        const curr=pt;
        if(!first){ const dx=curr.x-prev.x; const dy=curr.y-prev.y; for(const [sx,sy] of splitStep(dx,dy)) bodyBytes.push(...encodeStep(sx,sy,1)); prev=curr; first=true; continue; }
        const dx=curr.x-prev.x; const dy=curr.y-prev.y;
        for(const [sx,sy] of splitStep(dx,dy)) bodyBytes.push(...encodeStep(sx,sy,0)); prev=curr;
    }
    bodyBytes.push(0x00,0x00,0xF3);
    const header=new Uint8Array(512); header.fill(0x20);
    let name=prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ…ÙŠÙ… (DST) Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª:','DESIGN1')||'JS_FINAL';
    name=name.toUpperCase().substring(0,8);
    for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
    const buf=new Uint8Array(512+bodyBytes.length); buf.set(header,0); buf.set(new Uint8Array(bodyBytes),512); return buf.buffer;
}

document.getElementById('export-dst').onclick=()=>{
    if(strokes.length===0){ alert('Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const buf=buildDST(strokes); if(!buf){ alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù'); return; }
    const blob=new Blob([buf],{type:'application/octet-stream'}); 
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='design_final.dst'; a.click();
    URL.revokeObjectURL(url);
};

// ===== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© =====
const uploadInput=document.getElementById('upload');
const fileNameSpan=document.getElementById('file-name');
uploadInput.addEventListener('change',(e)=>{
    const file=e.target.files[0]; 
    if(file){ fileNameSpan.textContent=file.name; } else { fileNameSpan.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù"; }

    if(!file) return;
    const img=new Image(); const reader=new FileReader();
    reader.onload=function(ev){ img.src=ev.target.result; } 
    reader.readAsDataURL(file);
    img.onload=function(){
        const tmpCanvas=document.createElement('canvas'); const tmpCtx=tmpCanvas.getContext('2d');
        tmpCanvas.width=board.width; tmpCanvas.height=board.height; tmpCtx.drawImage(img,0,0,tmpCanvas.width,tmpCanvas.height);
        const imgData=tmpCtx.getImageData(0,0,tmpCanvas.width,tmpCanvas.height);
        const data=imgData.data; const width=tmpCanvas.width; const height=tmpCanvas.height;

        for(let i=0;i<data.length;i+=4){ const gray=0.3*data[i]+0.59*data[i+1]+0.11*data[i+2]; const val=gray<128?0:255; data[i]=data[i+1]=data[i+2]=val; }

        strokes=[]; const visited=Array(width*height).fill(false);
        function getIndex(x,y){ return y*width+x; }
        function trace(x,y,stroke){
            const stack=[[x,y]];
            while(stack.length){
                const [cx,cy]=stack.pop();
                if(cx<0||cy<0||cx>=width||cy>=height) continue;
                const idx=getIndex(cx,cy);
                if(visited[idx] || data[4*idx]===255) continue;
                visited[idx]=true;
                stroke.push({x:cx, y:cy});
                stack.push([cx+1,cy]); stack.push([cx-1,cy]); stack.push([cx,cy+1]); stack.push([cx,cy-1]);
            }
        }
        for(let y=0;y<height;y++){ for(let x=0;x<width;x++){
            const idx=getIndex(x,y);
            if(!visited[idx] && data[4*idx]===0){ const newStroke=[]; trace(x,y,newStroke); if(newStroke.length>5) strokes.push(newStroke); }
        }}

        ctx.clearRect(0,0,board.width,board.height); ctx.strokeStyle='#000'; ctx.lineWidth=1; ctx.lineJoin='round'; ctx.lineCap='round';
        for(const s of strokes){ ctx.beginPath(); ctx.moveTo(s[0].x,s[0].y); for(let i=1;i<s.length;i++) ctx.lineTo(s[i].x,s[i].y); ctx.stroke(); }
    }
});

document.getElementById('clear').onclick = ()=>{ strokes=[]; ctx.clearRect(0,0,board.width,board.height); };
</script>
</body>
</html>
