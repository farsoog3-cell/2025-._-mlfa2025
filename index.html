<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MLFA2025 - Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ² 2D</title>
<style>
/* ===== Ø³ØªØ§ÙŠÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
body, html { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#6a0dad,#ffffff); display:flex; justify-content:center; align-items:center; }
.login-container { background:rgba(255,255,255,0.95); padding:40px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.2); text-align:center; width:320px; }
.login-container h1{ color:#6a0dad; margin-bottom:20px; font-size:24px; }
.login-container input{ width:100%; padding:12px; margin:10px 0; border:2px solid #6a0dad; border-radius:8px; font-size:16px; }
.login-container button{ width:100%; padding:12px; background:#6a0dad; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer; transition:0.3s; }
.login-container button:hover{ background:#520a97; }
.message{ margin-top:15px; font-weight:bold; color:red; }
.message.success{ color:green; }

/* ===== Ø³ØªØ§ÙŠÙ„Ø§Øª Ù…Ø®Ø·Ø· Ø§Ù„ØªØ·Ø±ÙŠØ² ===== */
#app { display:none; flex-direction:column; height:100%; width:100%; background:#f0f2f5; }
header { background: linear-gradient(90deg,#4b6cb7,#182848); color:#fff; text-align:center; padding:15px 0; font-size:1.4em; font-weight:bold;}
#main { flex:1 1 auto; display:flex; justify-content:center; align-items:center; padding:20px;}
canvas { display:block; background:#fff; border-radius:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); border:2px solid #ccc;}
#board { width:80vmin; height:80vmin;}
.controls { flex:0 0 auto; padding:10px; background:#fff; display:flex; justify-content:center; align-items:center; border-top:2px solid #ddd; flex-wrap:wrap;}
button.control-btn { padding:8px 12px; margin:5px; border-radius:12px; border:none; cursor:pointer; transition:0.3s; background:#4b6cb7; color:#fff; font-weight:600; }
button.control-btn:hover { background:#182848; }
.upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
.upload-btn { background:#4b6cb7; color:white; font-weight:600; padding:8px 20px; border-radius:12px; cursor:pointer;}
.upload-btn-wrapper input[type=file] { font-size:100px; position:absolute; left:0; top:0; opacity:0; cursor:pointer; }
.warn { color:#d00; font-size:0.85em; margin-left:15px;}
</style>
</head>
<body>

<!-- ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== -->
<div class="login-container" id="loginDiv">
<h1>MLFA2025</h1>
<p>Ø¶Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø¯ÙŠÙƒ Ù‡Ù†Ø§</p>
<input type="text" id="keyInput" placeholder="Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
<button id="checkBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
<div class="message" id="message"></div>
</div>

<!-- ===== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== -->
<div id="app">
<header>Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ² - 2D Ù…Ù†Ø¶Ø¨Ø· ÙˆÙ…Ø­Ø³Ù†</header>
<div id="main"><canvas id="board"></canvas></div>
<div class="controls">
  <button class="control-btn" id="clear">Ù…Ø³Ø­</button>
  <button class="control-btn" id="export">ØªÙ†Ø²ÙŠÙ„ JSON ÙˆDST</button>
  <div class="upload-btn-wrapper">
    <button class="upload-btn">ğŸ“‚ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</button>
    <input type="file" id="upload" accept="image/*">
  </div>
  <div class="warn">ÙƒÙ„ Ø§Ù„ØºØ±Ø² Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙˆØ¯ ÙˆØ¯Ù‚Ø© Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø­ÙÙˆØ¸Ø©.</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD0Hh1e5lq4yfKO9iIPStC6wFfUgXH-6ps",
  authDomain: "fsgsvsb-3af4e.firebaseapp.com",
  projectId: "fsgsvsb-3af4e",
  storageBucket: "fsgsvsb-3af4e.firebasestorage.app",
  messagingSenderId: "740413309189",
  appId: "1:740413309189:web:86aa992833f1452d8d376c",
  measurementId: "G-TBP47X82ZE"
};
const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);

function getDeviceId(){
  let id = localStorage.getItem('mlfa_device_id');
  if(!id){
    id = 'dev-' + Math.random().toString(36).substring(2,12);
    localStorage.setItem('mlfa_device_id', id);
  }
  return id;
}
const deviceId = getDeviceId();

document.getElementById('checkBtn').addEventListener('click', checkKey);

async function checkKey(){
  const input = document.getElementById('keyInput').value.trim();
  const messageDiv = document.getElementById('message');
  if(!input){ messageDiv.textContent="Ù„Ù… ØªØ¶Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ø¹Ø¯!"; messageDiv.className="message"; return; }

  const q = query(collection(db,'keys'), where('key','==',input));
  const snap = await getDocs(q);
  if(snap.empty){ messageDiv.textContent="Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"; messageDiv.className="message"; return; }
  const docSnap = snap.docs[0]; const data = docSnap.data();

  if(data.deleted){ messageDiv.textContent="Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø¹Ø·Ù„ Ø£Ùˆ Ù…Ù„ØºÙŠ!"; messageDiv.className="message"; return; }

  const created = new Date(data.createdAt);
  const expiry = new Date(created); expiry.setDate(expiry.getDate() + Number(data.days || 0));
  if(expiry < new Date()){ messageDiv.textContent="Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙØªØ§Ø­!"; messageDiv.className="message"; return; }

  if(!data.deviceId){
    await updateDoc(docSnap.ref, { deviceId: deviceId });
  } else if(data.deviceId !== deviceId){
    messageDiv.textContent="Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù‡Ù†Ø§."; messageDiv.className="message"; return;
  }

  // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
  messageDiv.textContent="ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­."; messageDiv.className="message success";
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('app').style.display='flex';
  initEmbroidery(); // ØªÙ‡ÙŠØ¦Ø© Ù…Ø®Ø·Ø· Ø§Ù„ØªØ·Ø±ÙŠØ²
}

// ===== Ù‡Ù†Ø§ ØªØ¨Ø¯Ø£ Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ù…Ø®Ø·Ø· Ø§Ù„ØªØ·Ø±ÙŠØ² =====
function initEmbroidery(){
const board = document.getElementById('board');
const ctx = board.getContext('2d');
let strokes = [];
let imgWidth = 0, imgHeight = 0;
let dw = 0, dh = 0, offsetX = 0, offsetY = 0;

function resizeCanvas() { board.width = board.clientWidth; board.height = board.clientHeight; }
window.addEventListener('load', resizeCanvas);
window.addEventListener('resize', resizeCanvas);

function traceContours(imgData, width, height) {
    const data = imgData.data;
    const visited = Array(width*height).fill(false);
    const strokes = [];
    function getIndex(x,y){ return y*width+x; }
    function isBlack(x,y){ return data[4*getIndex(x,y)]<50; }

    function followContour(x0,y0){
        const contour=[];
        const stack=[[x0,y0]];
        while(stack.length>0){
            const [x,y] = stack.pop();
            if(x<0||y<0||x>=width||y>=height) continue;
            if(visited[getIndex(x,y)]||!isBlack(x,y)) continue;
            visited[getIndex(x,y)] = true;
            contour.push({x,y});
            [[1,0],[0,1],[-1,0],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dx,dy])=>stack.push([x+dx,y+dy]));
        }
        function simplify(points, epsilon){
            if(points.length<3) return points;
            let dmax=0, index=0;
            const end=points.length-1;
            for(let i=1;i<end;i++){
                const dx=points[end].x-points[0].x;
                const dy=points[end].y-points[0].y;
                const mag=Math.sqrt(dx*dx+dy*dy);
                const distance=Math.abs(dy*points[i].x - dx*points[i].y + points[end].x*points[0].y - points[end].y*points[0].x)/mag;
                if(distance>dmax){ dmax=distance; index=i; }
            }
            if(dmax>epsilon){
                const rec1=simplify(points.slice(0,index+1),epsilon);
                const rec2=simplify(points.slice(index),epsilon);
                return rec1.slice(0,-1).concat(rec2);
            } return [ ...points ];
        }
        return contour.length>4 ? simplify(contour,1) : null;
    }

    for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
            if(!visited[getIndex(x,y)] && isBlack(x,y)){
                const stroke = followContour(x,y);
                if(stroke) strokes.push(stroke);
            }
        }
    }
    return strokes;
}

function smoothStroke(points){
    if(points.length<3) return points;
    const smoothed=[points[0]];
    for(let i=1;i<points.length-2;i++){
        const p0=points[i-1],p1=points[i],p2=points[i+1],p3=points[i+2];
        for(let t=0;t<=1;t+=0.15){
            const tt=t*t,ttt=tt*tt*t;
            const x=0.5*((2*p1.x)+(-p0.x+p2.x)*t+(2*p0.x-5*p1.x+4*p2.x-p3.x)*tt+(-p0.x+3*p1.x-3*p2.x+p3.x)*ttt);
            const y=0.5*((2*p1.y)+(-p0.y+p2.y)*t+(2*p0.y-5*p1.y+4*p2.y-p3.y)*tt+(-p0.y+3*p1.y-3*p2.y+p3.y)*ttt);
            smoothed.push({x,y});
        }
    }
    smoothed.push(points[points.length-1]);
    return smoothed;
}

function animateStrokes(strokes, ctx){
    ctx.clearRect(0,0,board.width,board.height);
    ctx.strokeStyle='black';
    ctx.lineWidth=1;
    ctx.lineJoin='round';
    ctx.lineCap='round';
    const allPoints=[];
    for(const s of strokes){
        const smooth=smoothStroke(s);
        for(let i=1;i<smooth.length;i++) allPoints.push([smooth[i-1],smooth[i]]);
    }
    let index=0;
    function drawStep(){
        if(index>=allPoints.length) return;
        const [p1,p2]=allPoints[index];
        ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); index++;
        requestAnimationFrame(drawStep);
    }
    drawStep();
}

document.getElementById('upload').addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const img = new Image(); const reader = new FileReader();
    reader.onload=function(ev){ img.src=ev.target.result; }
    reader.readAsDataURL(file);
    img.onload=function(){
        imgWidth=img.width; imgHeight=img.height;
        const tmpCanvas=document.createElement('canvas');
        const tmpCtx=tmpCanvas.getContext('2d');
        tmpCanvas.width=board.width; tmpCanvas.height=board.height;
        const aspect=img.width/img.height;
        dw=tmpCanvas.width; dh=tmpCanvas.height;
        if(aspect>1){ dh=dw/aspect; } else { dw=dh*aspect; }
        offsetX=(tmpCanvas.width-dw)/2; offsetY=(tmpCanvas.height-dh)/2;
        tmpCtx.fillStyle='white'; tmpCtx.fillRect(0,0,tmpCanvas.width,tmpCanvas.height);
        tmpCtx.drawImage(img,offsetX,offsetY,dw,dh);
        const imgData=tmpCtx.getImageData(0,0,tmpCanvas.width,tmpCanvas.height);
        for(let i=0;i<imgData.data.length;i+=4){
            const gray=0.3*imgData.data[i]+0.59*imgData.data[i+1]+0.11*imgData.data[i+2];
            const val=gray<128?0:255;
            imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=val;
        }
        strokes=traceContours(imgData,tmpCanvas.width,tmpCanvas.height);
        animateStrokes(strokes,ctx);
    }
});

document.getElementById('clear').onclick=()=>{strokes=[];ctx.clearRect(0,0,board.width,board.height);};
document.getElementById('export').onclick=()=>{ alert("ØªÙ†Ø²ÙŠÙ„ JSON ÙˆDST Ù…ÙØ¹Ù‘Ù„"); /* ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù‡Ù†Ø§ */ };
}
</script>
</body>
</html>
