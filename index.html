<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة رسم DST دقيقة للغاية</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; font-family: 'Segoe UI', sans-serif; display:flex; flex-direction:column; background: #f0f2f5;}
header { background: linear-gradient(90deg,#4b6cb7,#182848); color:#fff; text-align:center; padding: 15px 0; font-size: 1.4em; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.2);}
#main { flex:1 1 auto; display:flex; justify-content:center; align-items:center; padding:20px;}
canvas { display:block; background:#fff; border-radius:20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border:2px solid #ccc;}
#board { width:80vmin; height:80vmin;}
.controls { flex:0 0 auto; padding:10px; background:#fff; display:flex; justify-content:center; align-items:center; border-top:2px solid #ddd; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); flex-wrap: wrap;}
button { padding:10px 16px; margin:5px; border-radius:12px; border:none; background: #4b6cb7; color:#fff; font-weight:600; cursor:pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
button:hover { background:#182848;}
.warn { color:#d00; font-size:0.85em; margin-left:15px;}
</style>
</head>
<body>
<header>لوحة رسم DST ذكية</header>
<div id="main"><canvas id="board"></canvas></div>
<div class="controls">
    <button id="undo">تراجع</button>
    <button id="clear">مسح</button>
    <button id="export-dst">تصدير DST</button>
    <div class="warn">ارسم على اللوح لتصدير ملف DST مطابق تمامًا لمساراتك.</div>
</div>

<script>
const board = document.getElementById('board');
const ctx = board.getContext('2d');
let strokes=[], current=[], drawing=false;

// إعداد التحجيم
const BOARD_MM = 100; 
const PX_PER_MM = board.width / BOARD_MM; 
function pxToMM(px){ return px / PX_PER_MM; }
function mmToPx(mm){ return mm * PX_PER_MM; }

const GRID_STEP_MM = 1; 
function drawGrid(){
    ctx.strokeStyle='#eee';
    ctx.lineWidth=0.5;
    const stepPx = mmToPx(GRID_STEP_MM);
    for(let x=0;x<=board.width;x+=stepPx){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,board.height); ctx.stroke(); }
    for(let y=0;y<=board.height;y+=stepPx){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(board.width,y); ctx.stroke(); }
}

function start(x,y){ drawing=true; current=[{x,y}]; }
function move(x,y){ if(!drawing) return; current.push({x,y}); redraw(); }
function end(){ if(!drawing) return; drawing=false; if(current.length) strokes.push(current); current=[]; redraw(); }

board.addEventListener('mousedown', e=>{ const r=board.getBoundingClientRect(); start(e.clientX-r.left,e.clientY-r.top); });
window.addEventListener('mousemove', e=>{ if(!drawing) return; const r=board.getBoundingClientRect(); move(e.clientX-r.left,e.clientY-r.top); });
window.addEventListener('mouseup', end);

board.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const r=board.getBoundingClientRect(); start(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
board.addEventListener('touchmove', e=>{ e.preventDefault(); const t=e.touches[0]; const r=board.getBoundingClientRect(); move(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
board.addEventListener('touchend', e=>{ e.preventDefault(); end(); }, {passive:false});

function redraw(){
    ctx.clearRect(0,0,board.width,board.height);
    drawGrid();
    ctx.lineWidth=1.5;
    ctx.strokeStyle='#000';
    ctx.lineJoin='round';
    ctx.lineCap='round';
    for(const s of strokes) drawStroke(s);
    drawStroke(current);
}

function drawStroke(st){ if(!st || st.length<2) return; ctx.beginPath(); ctx.moveTo(st[0].x,st[0].y); for(let i=1;i<st.length;i++) ctx.lineTo(st[i].x,st[i].y); ctx.stroke(); }

document.getElementById('clear').onclick = ()=>{ strokes=[]; current=[]; redraw(); };
document.getElementById('undo').onclick = ()=>{ strokes.pop(); redraw(); };

// ===== DST الذكي =====
const MAX_STEP = 2;

function splitStep(dx,dy){
    const steps=[]; let rx=dx, ry=dy;
    while(Math.abs(rx)>MAX_STEP || Math.abs(ry)>MAX_STEP){
        const sx=Math.max(-MAX_STEP, Math.min(MAX_STEP, rx));
        const sy=Math.max(-MAX_STEP, Math.min(MAX_STEP, ry));
        steps.push([sx,sy]); rx-=sx; ry-=sy;
    }
    steps.push([rx,ry]); return steps;
}

function encodeStep(dx,dy,control){
    let b0=0,b1=0,b2=0;
    function applyAxis(v,axis){ const sign=v<0?-1:1; let absv=Math.abs(v); const W=[81,27,9,3,1]; for(const w of W){ if(absv>=w){ if(axis==='x'){ if(w===1)b0|=(sign>0?0x01:0x02); else if(w===9)b0|=(sign>0?0x04:0x08); else if(w===3)b1|=(sign>0?0x01:0x02); else if(w===27)b1|=(sign>0?0x04:0x08); else if(w===81)b2|=(sign>0?0x20:0x40);} else { if(w===1)b0|=(sign>0?0x10:0x20); else if(w===9)b0|=(sign>0?0x40:0x80); else if(w===3)b1|=(sign>0?0x10:0x20); else if(w===27)b1|=(sign>0?0x40:0x80); else if(w===81)b2|=(sign>0?0x04:0x08);} absv-=w;}}}
    applyAxis(dx,'x'); applyAxis(dy,'y');
    if(control===0)b2|=0x03; else if(control===1)b2|=0x83; else if(control===2)b2|=0x23;
    return [b0&0xFF,b1&0xFF,b2&0xFF];
}

function buildDST(strokes){
    const allPoints=[];
    for(const stroke of strokes){
        for(const p of stroke) allPoints.push({x:pxToMM(p.x),y:pxToMM(p.y)});
        allPoints.push(null);
    }
    if(allPoints.length===0) return null;
    let prev=allPoints[0]||{x:0,y:0};
    const bodyBytes=[]; let first=false;
    for(const pt of allPoints){
        if(pt===null){ bodyBytes.push(...encodeStep(0,0,2)); first=false; continue; }
        const curr=pt;
        if(!first){ const dx=curr.x-prev.x; const dy=curr.y-prev.y; for(const [sx,sy] of splitStep(dx,dy)) bodyBytes.push(...encodeStep(sx,sy,1)); prev=curr; first=true; continue; }
        const dx=curr.x-prev.x; const dy=curr.y-prev.y;
        for(const [sx,sy] of splitStep(dx,dy)) bodyBytes.push(...encodeStep(sx,sy,0)); prev=curr;
    }
    bodyBytes.push(0x00,0x00,0xF3);
    const header=new Uint8Array(512); header.fill(0x20); const name='JS_SMART'; for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
    const buf=new Uint8Array(512+bodyBytes.length); buf.set(header,0); buf.set(new Uint8Array(bodyBytes),512); return buf.buffer;
}

document.getElementById('export-dst').onclick=()=>{
    if(strokes.length===0){ alert('ارسم شيئًا أولاً'); return; }
    const buf=buildDST(strokes); if(!buf){ alert('خطأ في إنشاء الملف'); return; }
    const blob=new Blob([buf],{type:'application/octet-stream'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='design_smart.dst'; a.click();
    URL.revokeObjectURL(url);
};

redraw();
</script>
</body>
</html>
