<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø§ØªØ±ÙˆÙ†Ø§Øª Ø§Ù„ØªØ·Ø±ÙŠØ² - Ù…Ø³Ø§Ø±Ø§Øª</title>
<style>
body { background:#000; color:#fff; font-family:Arial; text-align:center; margin:0; }
header { background:#111; padding:15px; border-bottom:2px solid #fff; }
section { max-width:900px; margin:30px auto; padding:20px; background:#111; border-radius:10px; }
canvas { margin-top:20px; border:1px solid #333; max-width:100%; }
button, input, select { padding:8px 12px; margin:5px; border-radius:5px; border:none; }
button { background:#222; color:#fff; cursor:pointer; }
button:hover { background:#444; }
</style>
</head>
<body>
<header>
    <h1>âœ¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ·Ø±ÙŠØ² âœ¨</h1>
</header>

<section>
    <input type="file" id="imageInput" accept="image/*">
    <button id="extractBtn">ğŸ“ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</button>
    <input type="text" id="fileName" value="stitch_pattern">
    <select id="fileType">
        <option value="pes">PES</option>
        <option value="png">PNG</option>
    </select>
    <button id="downloadBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„</button>
    <br>
    <canvas id="canvas"></canvas>
    <canvas id="patternCanvas" style="margin-top:20px;"></canvas>
    <div id="stitchInfo"></div>
</section>

<script>
const SERVER_URL = "http://localhost:5000/generate_pes"; // ØºÙŠÙ‘Ø±Ù‡ Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø±

const imageInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const patternCanvas = document.getElementById('patternCanvas');
const patternCtx = patternCanvas.getContext('2d');
const extractBtn = document.getElementById('extractBtn');
const downloadBtn = document.getElementById('downloadBtn');
const fileNameInput = document.getElementById('fileName');
const fileTypeSelect = document.getElementById('fileType');
const stitchInfo = document.getElementById('stitchInfo');

let img = new Image();
let stitchPaths = [];

// Ø±ÙØ¹ ØµÙˆØ±Ø©
imageInput.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        patternCanvas.width = img.width;
        patternCanvas.height = img.height;
        ctx.drawImage(img, 0, 0);
    };
    img.src = URL.createObjectURL(file);
});

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¹Ø¨Ø± ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯
extractBtn.addEventListener('click', () => {
    const width = canvas.width, height = canvas.height;
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;

    stitchPaths = [];
    patternCtx.clearRect(0, 0, width, height);
    patternCtx.strokeStyle = "#0f0";

    const threshold = 128;
    const visited = new Set();

    function isBlack(x, y) {
        if (x < 0 || y < 0 || x >= width || y >= height) return false;
        const i = (y * width + x) * 4;
        const gray = 0.3*data[i] + 0.59*data[i+1] + 0.11*data[i+2];
        return gray < threshold;
    }

    function trace(x, y) {
        const path = [];
        const stack = [[x,y]];
        while (stack.length) {
            const [cx, cy] = stack.pop();
            const key = cx + "," + cy;
            if (visited.has(key)) continue;
            visited.add(key);
            path.push({x: cx, y: cy});
            [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
                const nx = cx+dx, ny = cy+dy;
                if (isBlack(nx, ny)) stack.push([nx,ny]);
            });
        }
        return path;
    }

    for (let y=0; y<height; y+=5) {
        for (let x=0; x<width; x+=5) {
            if (isBlack(x,y) && !visited.has(x+","+y)) {
                const path = trace(x,y);
                if (path.length > 5) {
                    stitchPaths.push(path);
                    // Ø±Ø³Ù… ØªÙˆØ¶ÙŠØ­ÙŠ
                    patternCtx.beginPath();
                    patternCtx.moveTo(path[0].x, path[0].y);
                    for (let p of path) patternCtx.lineTo(p.x, p.y);
                    patternCtx.stroke();
                }
            }
        }
    }

    stitchInfo.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª: ${stitchPaths.length}`;
});

// ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
downloadBtn.addEventListener('click', () => {
    const fileName = fileNameInput.value || "stitch_pattern";
    const fileType = fileTypeSelect.value;

    if (fileType === "pes") {
        if (stitchPaths.length === 0) {
            alert("âš ï¸ Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹!");
            return;
        }
        fetch(SERVER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paths: stitchPaths })
        })
        .then(res => {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.blob();
        })
        .then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName + ".pes";
            link.click();
            stitchInfo.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PES (${stitchPaths.length} Ù…Ø³Ø§Ø±)`;
        })
        .catch(err => {
            console.error(err);
            stitchInfo.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PES.";
        });
    } else {
        const link = document.createElement('a');
        link.href = patternCanvas.toDataURL("image/png");
        link.download = fileName + ".png";
        link.click();
    }
});
</script>
</body>
</html>
